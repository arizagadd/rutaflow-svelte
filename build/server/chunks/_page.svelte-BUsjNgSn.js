import { c as create_ssr_component, d as subscribe, v as validate_component, a as add_attribute, e as escape, f as each } from './ssr-BvR1n3wf.js';
import { modalController } from '@ionic/core';
import { arrowBack, cashOutline, locationOutline } from 'ionicons/icons/index.mjs';
import { defineCustomElement } from '@ionic/core/components/ion-modal.js';
import { initialize } from '@ionic/core/components/index.js';
import { g as goto } from './client-DpIAX_q0.js';
import { DATABASE_URL } from './hooks-CyHAXwJN.js';
import { p as page, I as IonPage } from './IonPage-D5oPt8FW.js';
import './exports-BGi7-Rnc.js';

const registerCustomElement = (tagName, component) => {
  if (!customElements.get(tagName)) {
    class SvelteElement extends HTMLElement {
      constructor() {
        super();
        this.attachShadow({ mode: "open" });
      }
      connectedCallback() {
        const props = {};
        for (const attribute of this.attributes) {
          props[attribute.name] = attribute.value;
        }
        new component({
          target: this.shadowRoot,
          props
        });
      }
    }
    customElements.define(tagName, SvelteElement);
  }
};
const isRegistered = function(name) {
  return document.createElement(name).constructor !== HTMLElement;
};
const registerWebComponentOnce = (selector, component) => {
  if (!isRegistered(selector)) {
    registerCustomElement(selector, component);
  }
};
const IonicShowModal = async (selector, component, componentProps) => {
  initialize();
  defineCustomElement();
  registerWebComponentOnce(selector, component);
  const modal = await modalController.create({
    component: selector,
    componentProps
  });
  modal.present();
  return await modal.onWillDismiss();
};
const css$1 = {
  code: ".loadEvidence.svelte-1ruehls{position:relative;display:flex;align-items:center;justify-content:center;width:auto;height:auto}.button-content.svelte-1ruehls{display:flex;align-items:center;justify-content:center;width:100%;height:100%}.button-label.svelte-1ruehls{display:inline-block;margin-right:8px}.button-spinner.svelte-1ruehls{position:absolute;display:inline-block;width:24px;height:24px;z-index:1}",
  map: `{"version":3,"file":"_ChecklistControl.svelte","sources":["_ChecklistControl.svelte"],"sourcesContent":["<script>\\n    import GasKmModal from './GasKmModal.svelte';\\n    import {IonicShowModal} from \\"../../../../../services/IonicControllers\\";\\n    import { modalController } from '@ionic/core';\\n    import { checklistStore } from '../../../../../stores/checklistStore';\\n    import { alertController } from '@ionic/core';\\n    import { goto } from '$app/navigation';\\n\\timport { onMount } from 'svelte';\\n    import { gasKmStore } from '../../../../../stores/gasKmStore';\\n    import { flagStore } from '../../../../../stores/flagStore';\\n    import {DATABASE_URL} from '../../../../../hooks';\\n\\n    /*Back URL*/\\n    let back_url = DATABASE_URL;\\n    \\n    let overlayElement = document.querySelector(\\"ion-modal\\");\\n    const checklist = overlayElement.componentProps.checklist;\\n    const driverId = overlayElement.componentProps.driverId;\\n    const routeId = overlayElement.componentProps.routeId;\\n    const isLast = overlayElement.componentProps.isLast;\\n    let km_inicial,gas_inicial,km_final,gas_final;\\n    let checkk = [];\\n    let evidenceChecklist=null;\\n    let checkbox_item={};\\n    let KmInicial,GasInicial,KmFinal,GasFinal;\\n    let loadingStates = {};\\n    \\n\\n    // checklist trae las img en caso de que existan, declarar selectedImage como objeto\\n    let selectedImages = {};\\n    let imagesName = {};\\n\\n    onMount(() => {\\n        if(isLast){\\n            console.log(\\"Último checklist\\");\\n        }else{\\n            // guardar en store.items del checklistStore el valor de checklist (el total de checklist por ruta)\\n            checklistStore.update(store => {\\n                store.mandatory = getChecklistArray(checklist,\\"mandatory\\");\\n                store.items = getChecklistArray(checklist,\\"id_checklist_event\\");\\n                //store.mandatory = lv.mandatoryValues;\\n                return store;\\n            });\\n        }\\n        \\n    });\\n\\n    function startLoading(id) {\\n        loadingStates[id] = true;\\n    }\\n\\n    const alertIncompleteChecklist = async () => {\\n\\t\\tconst alert = await alertController.create({\\n\\t\\t\\theader: 'Datos o checklist incompletos',\\n\\t\\t\\tmessage: 'Carga la evidencia requerida y marca todas las casillas para confirmar',\\n\\t\\t\\tbuttons: [\\n                {\\n                    text: 'Cerrar'\\n                }\\n\\t\\t\\t]\\n\\t\\t});\\n\\t\\n\\t\\tawait alert.present();\\n\\t};\\n\\n    const alertDataSent = async () => {\\n\\t\\tconst alert = await alertController.create({\\n\\t\\t\\theader: 'Datos capturados',\\n\\t\\t\\tmessage: 'El kilometraje y gasolina final fueron registrados correctamente, espere aprobación para finalizar ruta',\\n\\t\\t\\tbuttons: [\\n                {\\n                    text: 'Cerrar'\\n                }\\n\\t\\t\\t]\\n\\t\\t});\\n\\t\\n\\t\\tawait alert.present();\\n\\t};\\n\\n    const alertInitialValues = async (u) => {\\n\\t\\tconst alert = await alertController.create({\\n\\t\\t\\theader: 'Datos inválidos',\\n\\t\\t\\tmessage: u==\\"km\\"?'Llena correctamente el campo de kilometraje inicial':'Llena correctamente el campo de gasolina inicial',\\n\\t\\t\\tbuttons: [\\n                {\\n                    text: 'Cerrar'\\n                }\\n\\t\\t\\t]\\n\\t\\t});\\n\\t\\n\\t\\tawait alert.present();\\n\\t};\\n\\n    function getChecklistArray(obj,type) {\\n\\n        // Ensure obj is an object or an array and not null\\n        if ((typeof obj === 'object' && obj !== null) || Array.isArray(obj)) {\\n            // If obj is an array, collect IDs from each object in the array\\n            if (Array.isArray(obj)) {\\n                return obj.map(item => getChecklistArray(item,type)).flat();\\n            } else {\\n                // Get the keys (property names) of the object\\n                const keys = Object.keys(obj);\\n                let idValues;\\n\\n                // Filter keys that are likely to be IDs (customize this based on your object structure)\\n                if(type==\\"id_checklist_event\\"){\\n                    const idKeys = keys.filter(key => key.toLowerCase().includes('id_checklist_event'));\\n                    idValues = idKeys.map(key => obj[key]);\\n                }else if(type==\\"mandatory\\"){\\n                    const mandatoryKeys = keys.filter(key => key.toLowerCase().includes('mandatory'));\\n                    // Extract the values corresponding to the identified ID keys\\n                    idValues = mandatoryKeys.map(key => obj[key]);\\n                }else{\\n                    console.error(\\"Tipo de dato no reconocido.\\");\\n                    idValues = false;\\n                }\\n\\n                return idValues;\\n            }\\n        } else {\\n            console.error('Invalid input. Please provide a valid object or array.');\\n            return [];\\n        }\\n    }\\n\\n    const closeOverlay = () => {\\n        modalController.dismiss();\\n        if(driverId){\\n            goto(\`/drivers/\${driverId}\`);\\n        }else{\\n            goto(\`/drivers/me\`)\\n        }\\n    };\\n    const sendEvidence = () => {\\n        if(isLast){\\n            var fin_km = transformFormatValue(km_final,\\"km\\");\\n            var fin_gas = transformFormatValue(gas_final,\\"gas\\");\\n            const formData = new FormData();\\n            formData.append(\`km_final\`,fin_km);\\n            formData.append(\`gas_final\`,fin_gas);\\n            formData.append(\`id_route\`,routeId);\\n            \\n            if(fin_km && fin_gas){\\n                //cerrar modal\\n                closeOverlay();\\n                \\n                fetch(\`\${back_url}api/admin/checklist/add_evidence.php\`, {\\n                    method: 'POST',\\n                    body: formData,\\n                    })\\n                    .then(response => response.json())\\n                    .then(data => {\\n                        alertDataSent();\\n                    })\\n                    .catch(error => {\\n                    console.error('Error fetching data:', error);\\n                });\\n            }else{\\n                alertIncompleteChecklist();\\n            }\\n        }else{\\n            var ini_km = transformFormatValue(km_inicial,\\"km\\");\\n            var ini_gas = transformFormatValue(gas_inicial,\\"gas\\");\\n            checklistStore.update(store => {\\n                const itemIds = store.items;\\n                const mandatoryVal = store.mandatory;\\n                // Extract the mandatory items\\n                const mandatoryItems = store.items.filter((item, index) => store.mandatory[index] === \\"1\\");\\n                // Check if all mandatory items are checked\\n                const allMandatoryChecked = mandatoryItems.every(mandatoryItem =>\\n                    store.checkedIndices.includes(mandatoryItem)\\n                );\\n                if (allMandatoryChecked && ini_km && ini_gas) {\\n                    closeOverlay();\\n                    const formData = new FormData();\\n\\n                    // Iterate over the selectedImages object\\n                    for (const key in selectedImages) {\\n                        if (selectedImages.hasOwnProperty(key)) {\\n                            const { img, img_id } = selectedImages[key]; // Destructure img and img_id from the selectedImages[key] object\\n                            formData.append(\`selectedImages[\${key}][img]\`, img); // Append the image URL\\n                            formData.append(\`selectedImages[\${key}][img_id]\`, img_id); // Append the image ID\\n                        }\\n                    }\\n                    formData.append(\`km_inicial\`,ini_km);\\n                    formData.append(\`gas_inicial\`,ini_gas);\\n                    formData.append(\`id_route\`,routeId);\\n                    fetch(\`\${back_url}api/admin/checklist/add_evidence.php\`, {\\n                        method: 'POST',\\n                        body: formData,\\n                        })\\n                        .then(response => response.json())\\n                        .then(data => {\\n                            if (mandatoryVal && mandatoryVal.some(val => val === '1')) {\\n                                changeRouteStatus(routeId, 'checklist-pending');\\n                            } else {\\n                                changeRouteStatus(routeId, 'enroute');\\n                            }\\n                        })\\n                        .catch(error => {\\n                            console.error('Error fetching data:', error);\\n                        });\\n                    //goto(\`/drivers/\${driverId}/routes/\${routeId}\`);\\n                    //window.location.reload();\\n                }else if(!mandatoryVal && ini_km && ini_gas){\\n                    var formData = new FormData();\\n                    formData.append(\`km_inicial\`,ini_km);\\n                    formData.append(\`gas_inicial\`,ini_gas);\\n                    fetch(\`\${back_url}api/admin/checklist/add_evidence.php\`, {\\n                        method: 'POST',\\n                        body: formData,\\n                        })\\n                        .then(response => response.json())\\n                        .then(data => {\\n                            changeRouteStatus(routeId, 'enroute');\\n                        })\\n                        .catch(error => {\\n                        console.error('Error fetching data:', error);\\n                        });\\n                }else {\\n                    alertIncompleteChecklist();\\n                }\\n\\n                return store;\\n            });\\n        }\\n        emptyGasKmStore();\\n    };\\n\\n    const handleFileChange = async (event, checklistItemId) => {\\n        startLoading(checklistItemId);\\n        const fileInput = event.target;\\n        const file = fileInput.files[0];\\n        const compressed_file = await compressImage(file);\\n\\n        if (compressed_file) {\\n            const formData = new FormData();\\n            formData.append('fileToUpload', compressed_file);\\n            try {\\n                const response = await fetch(\`\${back_url}api/admin/manager/upload_img_driver.php\`, {\\n                    method: 'POST',\\n                    body: formData,\\n                });\\n\\n                if (response.ok) {\\n                    // File uploaded successfully, handle any additional logic\\n                    const result = await response.json();\\n\\n                    selectedImages = {\\n                        ...selectedImages,\\n                        [checklistItemId]: {\\n                            img: result.img, // Store the image URL\\n                            img_id: result.img_id // Store the image ID\\n                        }\\n                    };\\n                    imagesName = {\\n                        ...imagesName,\\n                        [checklistItemId]: result.filename,\\n                    };\\n\\n                    markCheckbox(checklistItemId);\\n                    checkbox_item[checklistItemId].checked =true; \\n                    \\n                    // Reset loading state after success\\n                    loadingStates[checklistItemId] = false;\\n                } else {\\n                    // Handle error response\\n                    console.error('File upload failed:', response.statusText);\\n                }\\n            } catch (error) {\\n                console.error('Error during file upload:', error);\\n            }\\n        }\\n    };\\n    const compressImage = async (file) => {\\n        return new Promise((resolve) => {\\n            const reader = new FileReader();\\n\\n            reader.onload = (event) => {\\n                const img = new Image();\\n                img.src = event.target.result;\\n\\n                img.onload = () => {\\n                    const canvas = document.createElement('canvas');\\n                    const ctx = canvas.getContext('2d');\\n\\n                    // Set the canvas size to a reasonable value\\n                    const maxWidth = 800;\\n                    const maxHeight = 600;\\n\\n                    let width = img.width;\\n                    let height = img.height;\\n\\n                    if (width > maxWidth) {\\n                        height *= maxWidth / width;\\n                        width = maxWidth;\\n                    }\\n\\n                    if (height > maxHeight) {\\n                        width *= maxHeight / height;\\n                        height = maxHeight;\\n                    }\\n\\n                    canvas.width = width;\\n                    canvas.height = height;\\n\\n                    ctx.drawImage(img, 0, 0, width, height);\\n\\n                    // Get the compressed data as a Blob\\n                    canvas.toBlob((blob) => {\\n                        resolve(blob);\\n                    }, 'image/jpeg', 0.7); // Adjust the quality as needed\\n                };\\n            };\\n\\n            reader.readAsDataURL(file);\\n        });\\n    };\\n\\n    const markCheckbox = (id) => {\\n        checklistStore.update(store => {\\n            const existingIndex = store.checkedIndices.indexOf(id);\\n\\n            if (existingIndex === -1) {\\n                // The ID is not in the array, add it\\n                store.checkedIndices.push(id);\\n            } else {\\n                // The ID is already in the array, you may want to handle this case\\n                console.error(\`ID \${id} is already checked.\`);\\n            }\\n\\n            // Mark the corresponding checkbox in the items array\\n            store.items.forEach(item => {\\n                if (item.id_checklist_event === id) {\\n                    item.checked = true;\\n                }\\n            });\\n\\n            return store;\\n        });\\n    };\\n\\n    function changeRouteStatus(id_route,status){\\n        let requestData = new FormData();\\n        requestData.append('id_route', id_route);\\n        requestData.append('status',status);\\n        fetch(\`\${back_url}api/admin/route/change_status.php\`, {\\n                method: 'POST',\\n                body: requestData,\\n                })\\n                .then(response => response.json())\\n                .then(data => {\\n                    //console.log(data);\\n                })\\n                .catch(error => {\\n                console.error('Error fetching data:', error);\\n            });\\n    }\\n\\n    function transformFormatValue(value,u){\\n        // Check if the value contains only numeric characters\\n        if (/^\\\\d+$/.test(value)) {\\n            // Convert the string value to an integer\\n            const intValue = parseInt(value, 10);\\n            return intValue;\\n        } else {\\n            // If the value contains non-numeric characters, return null or handle the error accordingly\\n            alertInitialValues(u);\\n            return null;\\n        }\\n    }\\n\\n    function handleKmGasData(e,r){\\n        updateFlagStore(r);\\n        overlayElement.componentProps.data_type = r;\\n        IonicShowModal(\\"modal-gas-km\\", GasKmModal, {\\n            r\\n        }).then(() => {\\n            gasKmStore.subscribe((result) => {\\n                setButtonTxt(result,r);\\n                \\n            });\\n            \\n         });\\n    }\\n\\n    function updateFlagStore(type){\\n        flagStore.update(store => ({\\n          ...store,\\n          flag: [type]\\n      }));\\n    }\\n\\n    function setButtonTxt(obj,r){\\n        km_inicial = obj.km_inicial? obj.km_inicial: null;\\n        gas_inicial = obj.gas_inicial? obj.gas_inicial : null;\\n        km_final = obj.km_final? obj.km_final: null;\\n        gas_final = obj.gas_final? obj.gas_final : null;\\n        r=='km_inicial' && KmInicial ?KmInicial.checked=true:\\"\\";\\n        r=='gas_inicial' && GasInicial?GasInicial.checked=true:\\"\\";\\n        r=='km_final' && KmFinal?KmFinal.checked=true:\\"\\";\\n        r=='gas_final' && GasFinal?GasFinal.checked=true:\\"\\";\\n        let checkbox;\\n    }\\n\\n    function emptyGasKmStore(){\\n        gasKmStore.set({\\n            km_inicial: [],\\n            gas_inicial: [],\\n            km_final: [],\\n            gas_final: []\\n        });\\n    }\\n\\n<\/script>\\n\\n<ion-header translucent>\\n    <ion-toolbar>\\n      <ion-buttons slot=\\"start\\">\\n        <ion-button color=\\"medium\\" on:click={closeOverlay}>Cancelar</ion-button>\\n      </ion-buttons>\\n      <ion-title>REQUERIMIENTOS DE RUTA</ion-title>\\n    </ion-toolbar>\\n</ion-header>\\n<ion-content fullscreen>\\n    <ion-list>\\n        {#if isLast}\\n            <ion-item>\\n                <ion-label style=\\"display:flex;\\">\\n                    <input\\n                    id={\`chkbox-km-fin\`}\\n                    style=\\"pointer-events: auto;\\"\\n                    type=\\"checkbox\\"\\n                    bind:group={checkk}\\n                    bind:this = {KmFinal}\\n                    required\\n                    />\\n                    <p style=\\"margin-left:10px;\\">Kilometraje final</p>\\n                </ion-label>\\n                <ion-button fill=\\"outline\\" size=\\"small\\" class=\\"loadKmInicial\\" on:click={(e) => handleKmGasData(e,\\"km_final\\")} aria-selected>\\n                    <!-- <label for=\\"chkbox-km-fin\\" style=\\"padding: 8px 10px\\"> -->\\n                        {km_final?km_final+\\" km.\\":\\"Cargar km\\"}\\n                    <!-- </label> -->\\n                </ion-button>\\n            </ion-item>\\n            <ion-item>\\n                <ion-label style=\\"display:flex;\\">\\n                    <input\\n                    id={\`chkbox-gas-fin\`}\\n                    style=\\"pointer-events: auto;\\"\\n                    type=\\"checkbox\\"\\n                    bind:group={checkk}\\n                    bind:this = {GasFinal}\\n                    required\\n                    />\\n                    <p style=\\"margin-left:10px;\\">Gasolina final (litros)</p>\\n                </ion-label>\\n                <ion-button fill=\\"outline\\" size=\\"small\\" class=\\"loadGasInicial\\" on:click={(e) => handleKmGasData(e,\\"gas_final\\")}>\\n                    <!-- <label for=\\"chklist-gas-fin\\" style=\\"padding: 8px 10px\\"> -->\\n                        {gas_final?gas_final+\\" litros\\":\\"Cargar gas\\"}\\n                    <!-- </label> -->\\n                </ion-button>\\n            </ion-item>\\n        {:else}\\n            <ion-item>\\n                <ion-label style=\\"display:flex;\\">\\n                    <input\\n                    id={\`chkbox-km-ini\`}\\n                    style=\\"pointer-events: auto;\\"\\n                    type=\\"checkbox\\"\\n                    bind:group={checkk}\\n                    bind:this = {KmInicial}\\n                    required\\n                    />\\n                    <p style=\\"margin-left:10px;\\">Kilometraje inicial</p>\\n                </ion-label>\\n                <ion-button fill=\\"outline\\" size=\\"small\\" class=\\"loadKmInicial\\" on:click={(e) => handleKmGasData(e,\\"km_inicial\\")} aria-selected>\\n                    <!-- <label for=\\"chklist-km-ini\\" style=\\"padding: 8px 10px\\"> -->\\n                        {km_inicial?km_inicial+\\" km.\\":\\"Cargar km\\"}\\n                    <!-- </label> -->\\n                </ion-button>\\n            </ion-item>\\n            <ion-item>\\n                <ion-label style=\\"display:flex;\\">\\n                    <input\\n                    id={\`chkbox-gas-ini\`}\\n                    style=\\"pointer-events: auto;\\"\\n                    type=\\"checkbox\\"\\n                    bind:this = {GasInicial}\\n                    bind:group={checkk}\\n                    required\\n                    />\\n                    <p style=\\"margin-left:10px;\\">Gasolina inicial (litros)</p>\\n                </ion-label>\\n                <ion-button fill=\\"outline\\" class=\\"loadGasInicial\\" size=\\"small\\" on:click={(e) => handleKmGasData(e,\\"gas_inicial\\")} style=\\"height: 16px \\">\\n                    <!-- <label for=\\"chklist-gas-ini\\" style=\\"padding: 8px 10px\\"> -->\\n                        {gas_inicial?gas_inicial+\\" litros\\":\\"Cargar gas\\"}\\n                    <!-- </label> -->\\n                </ion-button>\\n            </ion-item>\\n            <!-- <ion-item>\\n                <ion-input class=\\"ini-km\\" type=\\"number\\" label=\\"Kilometraje inicial\\" labelPlacement=\\"stacked\\" placeholder=\\"Ingresa kilometraje actual\\" bind:this={initial_km}  required></ion-input>\\n            </ion-item>\\n            <ion-item>\\n                <ion-input class=\\"gas-km\\" type=\\"number\\" label=\\"Gasolina inicial (litros)\\" labelPlacement=\\"stacked\\" placeholder=\\"Ingresa la gas actual\\"  bind:this={initial_gas} required></ion-input>\\n            </ion-item> -->\\n        {/if}\\n        {#if checklist}\\n            {#each checklist as check (check.id_checklist_event)}\\n                \\n                    <ion-item>\\n                        <ion-label style=\\"display:flex;\\">\\n                            <input\\n                            id={\`chkbox-\${check.id_checklist_event}\`}\\n                            style=\\"pointer-events: auto;\\"\\n                            type=\\"checkbox\\"\\n                            value={check.id_checklist_event}\\n                            bind:group={checkk}\\n                            bind:this = {checkbox_item[check.id_checklist_event]}\\n                            on:change={() => markCheckbox(check.id_checklist_event)}\\n                            required\\n                            />\\n                            <p style=\\"margin-left:10px;\\">{check.item} </p><b style=\\"margin-left:5px;\\">{check.mandatory == \\"1\\"?\\" * \\":\\"\\"} </b>\\n                        </ion-label>\\n                        <ion-button fill=\\"outline\\" class=\\"loadEvidence\\" size=\\"small\\">\\n                            <div class=\\"button-content\\">\\n                                {#if loadingStates[check.id_checklist_event]}\\n                                    <ion-spinner name=\\"dots\\" class=\\"button-spinner\\"></ion-spinner>\\n                                {:else}\\n                                    <label for=\\"chklist-{check.id_checklist_event}\\" class=\\"button-label\\">\\n                                        {imagesName[check.id_checklist_event] ? imagesName[check.id_checklist_event] : 'Cargar evidencia'}\\n                                    </label>\\n                                {/if}\\n                                <input style=\\"display:none;\\" id=\\"chklist-{check.id_checklist_event}\\" name=\\"fileToUpload\\" type=\\"file\\" bind:this={evidenceChecklist} accept=\\"image/*\\" on:change={(e) => handleFileChange(e, check.id_checklist_event)}>\\n                            </div>\\n                        </ion-button>\\n                    </ion-item>\\n                \\n            {/each}\\n        {/if}\\n    </ion-list>\\n</ion-content>\\n<ion-footer>\\n    <!-- <ion-buttons style=\\"width: 100%; height: 100%;\\"> -->\\n        <ion-button fill=\\"outline\\" color=\\"tertiary\\" on:click={sendEvidence} strong style=\\"width: 99%; height: auto;\\">\\n            Confirmar\\n        </ion-button>\\n    <!-- </ion-buttons> -->\\n</ion-footer>\\n\\n<style>\\n    .loadEvidence {\\n        position: relative;\\n        display: flex;\\n        align-items: center;\\n        justify-content: center;\\n        width: auto; /* Adjust button width */\\n        height: auto; /* Adjust button height */\\n    }\\n\\n    .button-content {\\n        display: flex;\\n        align-items: center;\\n        justify-content: center;\\n        width: 100%;\\n        height: 100%;\\n    }\\n\\n    .button-label {\\n        display: inline-block;\\n        margin-right: 8px; /* Adjust margin as needed */\\n    }\\n\\n    .button-spinner {\\n        position: absolute;\\n        display: inline-block;\\n        width: 24px; /* Adjust spinner size as needed */\\n        height: 24px; /* Adjust spinner size as needed */\\n        z-index: 1; /* Ensure spinner is on top */\\n    }\\n</style>"],"names":[],"mappings":"AAwiBI,4BAAc,CACV,QAAQ,CAAE,QAAQ,CAClB,OAAO,CAAE,IAAI,CACb,WAAW,CAAE,MAAM,CACnB,eAAe,CAAE,MAAM,CACvB,KAAK,CAAE,IAAI,CACX,MAAM,CAAE,IACZ,CAEA,8BAAgB,CACZ,OAAO,CAAE,IAAI,CACb,WAAW,CAAE,MAAM,CACnB,eAAe,CAAE,MAAM,CACvB,KAAK,CAAE,IAAI,CACX,MAAM,CAAE,IACZ,CAEA,4BAAc,CACV,OAAO,CAAE,YAAY,CACrB,YAAY,CAAE,GAClB,CAEA,8BAAgB,CACZ,QAAQ,CAAE,QAAQ,CAClB,OAAO,CAAE,YAAY,CACrB,KAAK,CAAE,IAAI,CACX,MAAM,CAAE,IAAI,CACZ,OAAO,CAAE,CACb"}`
};
const ChecklistControl = create_ssr_component(($$result, $$props, $$bindings, slots) => {
  let overlayElement = document.querySelector("ion-modal");
  const checklist = overlayElement.componentProps.checklist;
  overlayElement.componentProps.driverId;
  overlayElement.componentProps.routeId;
  const isLast = overlayElement.componentProps.isLast;
  let checkk = [];
  let checkbox_item = {};
  let KmInicial, GasInicial, KmFinal, GasFinal;
  let loadingStates = {};
  let imagesName = {};
  $$result.css.add(css$1);
  return `<ion-header translucent><ion-toolbar><ion-buttons slot="start"><ion-button color="medium" data-svelte-h="svelte-1dnmkxs">Cancelar</ion-button></ion-buttons> <ion-title data-svelte-h="svelte-19bar5p">REQUERIMIENTOS DE RUTA</ion-title></ion-toolbar></ion-header> <ion-content fullscreen><ion-list>${isLast ? `<ion-item><ion-label style="display:flex;"><input${add_attribute("id", `chkbox-km-fin`, 0)} style="pointer-events: auto;" type="checkbox" required${add_attribute("this", KmFinal, 0)}> <p style="margin-left:10px;" data-svelte-h="svelte-ccmu71">Kilometraje final</p></ion-label> <ion-button fill="outline" size="small" class="loadKmInicial" aria-selected> ${escape("Cargar km")} </ion-button></ion-item> <ion-item><ion-label style="display:flex;"><input${add_attribute("id", `chkbox-gas-fin`, 0)} style="pointer-events: auto;" type="checkbox" required${add_attribute("this", GasFinal, 0)}> <p style="margin-left:10px;" data-svelte-h="svelte-wsoyd2">Gasolina final (litros)</p></ion-label> <ion-button fill="outline" size="small" class="loadGasInicial"> ${escape("Cargar gas")} </ion-button></ion-item>` : `<ion-item><ion-label style="display:flex;"><input${add_attribute("id", `chkbox-km-ini`, 0)} style="pointer-events: auto;" type="checkbox" required${add_attribute("this", KmInicial, 0)}> <p style="margin-left:10px;" data-svelte-h="svelte-88twxi">Kilometraje inicial</p></ion-label> <ion-button fill="outline" size="small" class="loadKmInicial" aria-selected> ${escape("Cargar km")} </ion-button></ion-item> <ion-item><ion-label style="display:flex;"><input${add_attribute("id", `chkbox-gas-ini`, 0)} style="pointer-events: auto;" type="checkbox" required${add_attribute("this", GasInicial, 0)}> <p style="margin-left:10px;" data-svelte-h="svelte-1ux30eb">Gasolina inicial (litros)</p></ion-label> <ion-button fill="outline" class="loadGasInicial" size="small" style="height: 16px "> ${escape("Cargar gas")} </ion-button></ion-item> `} ${checklist ? `${each(checklist, (check) => {
    return `<ion-item><ion-label style="display:flex;"><input${add_attribute("id", `chkbox-${check.id_checklist_event}`, 0)} style="pointer-events: auto;" type="checkbox"${add_attribute("value", check.id_checklist_event, 0)} required${~checkk.indexOf(check.id_checklist_event) ? add_attribute("checked", true, 1) : ""}${add_attribute("this", checkbox_item[check.id_checklist_event], 0)}> <p style="margin-left:10px;">${escape(check.item)} </p><b style="margin-left:5px;">${escape(check.mandatory == "1" ? " * " : "")} </b></ion-label> <ion-button fill="outline" class="loadEvidence svelte-1ruehls" size="small"><div class="button-content svelte-1ruehls">${loadingStates[check.id_checklist_event] ? `<ion-spinner name="dots" class="button-spinner svelte-1ruehls"></ion-spinner>` : `<label for="${"chklist-" + escape(check.id_checklist_event, true)}" class="button-label svelte-1ruehls">${escape(imagesName[check.id_checklist_event] ? imagesName[check.id_checklist_event] : "Cargar evidencia")} </label>`} <input style="display:none;" id="${"chklist-" + escape(check.id_checklist_event, true)}" name="fileToUpload" type="file" accept="image/*"> </div></ion-button> </ion-item>`;
  })}` : ``}</ion-list></ion-content> <ion-footer> <ion-button fill="outline" color="tertiary" strong style="width: 99%; height: auto;" data-svelte-h="svelte-g82qqw">Confirmar</ion-button>  </ion-footer>`;
});
const css = {
  code: ".sub.svelte-egzizz{font-size:12px;margin-top:5px}.order-wrapper.svelte-egzizz{width:100%;height:100%;border-radius:50%;border:1px solid #CBCFDE;text-align:center;display:flex;justify-content:center}.order.svelte-egzizz{align-self:center}.notes.svelte-egzizz{background-color:#e0b500;display:inline-block;width:8px;height:8px;border-radius:50%}",
  map: `{"version":3,"file":"+page.svelte","sources":["+page.svelte"],"sourcesContent":["<script lang=\\"ts\\">var __awaiter = (this && this.__awaiter) || function (thisArg, _arguments, P, generator) {\\n    function adopt(value) { return value instanceof P ? value : new P(function (resolve) { resolve(value); }); }\\n    return new (P || (P = Promise))(function (resolve, reject) {\\n        function fulfilled(value) { try { step(generator.next(value)); } catch (e) { reject(e); } }\\n        function rejected(value) { try { step(generator[\\"throw\\"](value)); } catch (e) { reject(e); } }\\n        function step(result) { result.done ? resolve(result.value) : adopt(result.value).then(fulfilled, rejected); }\\n        step((generator = generator.apply(thisArg, _arguments || [])).next());\\n    });\\n};\\nexport let routeId;\\nexport let driverId;\\nimport DeliveryInfo from './_DeliveryInfo.svelte';\\nimport IonPage from 'ionic-svelte/components/IonPage.svelte';\\nimport ChecklistControl from './_ChecklistControl.svelte';\\nimport AddExpense from './_AddExpense.svelte';\\nimport ExpenseDetails from './_ExpenseDetails.svelte';\\nimport { onMount, tick } from 'svelte';\\nimport { IonicShowModal } from \\"../../../../../services/IonicControllers\\";\\nimport { alertController } from '@ionic/core';\\nimport { page } from '$app/stores';\\nimport { goto } from '$app/navigation';\\nimport { locationOutline, cashOutline } from \\"ionicons/icons\\";\\nimport { arrowBack } from \\"ionicons/icons\\";\\nimport { DATABASE_URL } from '../../../../../hooks';\\n/*Back URL*/\\nlet back_url = DATABASE_URL;\\nlet dataSession = new Object();\\nlet loading = true;\\nlet showChecklist = false;\\nlet deliveries = [];\\nlet stats = {};\\nlet checklist = [];\\nlet expenses = [];\\nlet refresher;\\nlet isModalOpen = false;\\nlet segmentValue = \\"list\\"; // Controls the tab selection\\nlet mapElement;\\nconst refresh = () => __awaiter(void 0, void 0, void 0, function* () {\\n    yield loadRoute(routeId);\\n    refresher.complete();\\n});\\nonMount(() => __awaiter(void 0, void 0, void 0, function* () {\\n    yield loadRoute(routeId);\\n}));\\n$: {\\n    ({ routeId, driverId } = $page.params);\\n    dataSession = JSON.parse(localStorage.getItem('userSession'));\\n    if (dataSession) {\\n        if (dataSession.id_user && (dataSession.type == \\"admin\\" || dataSession.type == \\"super\\")) {\\n            loadRoute(routeId);\\n            goto(\`/drivers/me/routes/\${routeId}\`);\\n        }\\n        else if (dataSession.id_user && dataSession.id_driver) {\\n            loadRoute(routeId);\\n            goto(\`/drivers/\${dataSession.id_driver}/routes/\${routeId}\`);\\n        }\\n    }\\n    else {\\n        goto('/');\\n    }\\n}\\nfunction setSegmentValue(value) {\\n    return __awaiter(this, void 0, void 0, function* () {\\n        segmentValue = value;\\n        if (segmentValue === \\"map\\") {\\n            yield tick();\\n            mapElement = document.getElementById(\\"g_map\\");\\n            const map = new google.maps.Map(mapElement, {\\n                zoom: 8,\\n                center: { lat: 20.6745683, lng: -103.3986104 },\\n                mapId: \\"4504f8b37365c3d0\\"\\n            });\\n            const bounds = new google.maps.LatLngBounds();\\n            const { AdvancedMarkerElement, PinElement } = yield google.maps.importLibrary(\\"marker\\");\\n            // Get user's current location\\n            if (navigator.geolocation) {\\n                navigator.geolocation.getCurrentPosition(function (position) {\\n                    const userLatLng = new google.maps.LatLng(position.coords.latitude, position.coords.longitude);\\n                    // Add a blue dot to indicate the user's location\\n                    new google.maps.Marker({\\n                        position: userLatLng,\\n                        map: map,\\n                        icon: {\\n                            path: google.maps.SymbolPath.CIRCLE,\\n                            fillColor: '#0062ff',\\n                            fillOpacity: 1.0,\\n                            scale: 6, // Adjust size as needed\\n                            strokeColor: '#ffffff',\\n                            strokeWeight: 2\\n                        }\\n                    });\\n                    // Optional: Draw an accuracy circle around the user's location\\n                    new google.maps.Circle({\\n                        strokeColor: '#00BFFF',\\n                        strokeOpacity: 0.5,\\n                        strokeWeight: 1,\\n                        fillColor: '#00BFFF',\\n                        fillOpacity: 0.2,\\n                        map: map,\\n                        center: userLatLng,\\n                        radius: position.coords.accuracy // Radius is based on accuracy of location\\n                    });\\n                    // Extend the map bounds to include the user's location\\n                    bounds.extend(userLatLng);\\n                }, function (error) {\\n                    console.error(\\"Error retrieving location:\\", error);\\n                });\\n            }\\n            else {\\n                console.error(\\"Geolocation not supported by this browser.\\");\\n            }\\n            //For origin marker\\n            createMarker(bounds, map, { lat: stats.lat1, lon: stats.lon1, color: stats.color, title: stats.origin }, { type: \\"icon\\", iconClass: \\"icon-home\\", title: \\"Origen\\", glyph: \\"0\\" });\\n            //For destination marker\\n            createMarker(bounds, map, { lat: stats.lat2, lon: stats.lon2, color: stats.color, title: stats.destination }, { type: \\"icon\\", iconClass: \\"icon-flag\\", title: \\"Destino\\", glyph: String(deliveries.length + 1) });\\n            // Example of adding markers for stops/events\\n            deliveries.forEach((delivery, index) => {\\n                const lat = parseFloat(delivery.lat);\\n                const lon = parseFloat(delivery.lon);\\n                const waypointLatLng = new google.maps.LatLng(lat, lon);\\n                const marker = new google.maps.Marker({\\n                    position: { lat: lat, lng: lon },\\n                    map: map,\\n                    title: delivery.title,\\n                });\\n                // Change the background color.\\n                const pin = new PinElement({\\n                    background: getDeliveryColor(delivery.status, delivery.date_service),\\n                    borderColor: \\"#000\\",\\n                    glyphColor: \\"#000\\",\\n                    glyph: (parseInt(delivery.pos) + 1).toString()\\n                });\\n                const waypointMarker = new AdvancedMarkerElement({\\n                    map: map,\\n                    position: waypointLatLng,\\n                    content: pin.element,\\n                    title: \\"Parada \\" + (parseInt(delivery.pos) + 1).toString() + \\": \\" + delivery.title,\\n                });\\n                // Add a click listener for each marker, and set up the info window.\\n                waypointMarker.addListener(\\"click\\", function (domEvent) {\\n                    const { target } = domEvent;\\n                    showDeliveryInfoModal(delivery, false);\\n                });\\n                bounds.extend(marker.getPosition());\\n            });\\n            // Adjust map to fit all markers\\n            map.fitBounds(bounds);\\n        }\\n    });\\n}\\nfunction createMarker(bounds, map, obj, contentConfig) {\\n    return __awaiter(this, void 0, void 0, function* () {\\n        let contentElement;\\n        const lat = parseFloat(obj.lat);\\n        const lon = parseFloat(obj.lon);\\n        const waypointLatLng = new google.maps.LatLng(lat, lon);\\n        const { AdvancedMarkerElement, PinElement } = yield google.maps.importLibrary(\\"marker\\");\\n        if (contentConfig.type == \\"icon\\") {\\n            contentElement = document.createElement(\\"i\\");\\n            contentElement.className = \`\${contentConfig.iconClass} icon\`; // Add your icon class\\n            contentElement.style.fontSize = \\"14px\\"; // Adjust size as needed\\n            contentElement.style.color = getContrast(obj.color); // Set color dynamically\\n            contentElement.style.fontWeight = \\"600\\";\\n        }\\n        else if (contentConfig.type == \\"text\\") {\\n            //En caso de que queramos usar la función \\"createMarker\\" para agregar markers con texto\\n        }\\n        const marker = new google.maps.Marker({\\n            position: { lat: lat, lng: lon },\\n            map: map,\\n            title: \`\${contentConfig.title}. \${obj.title}\`,\\n        });\\n        // Change the background color.\\n        const pin = new PinElement({\\n            background: obj.color,\\n            borderColor: \\"#000\\",\\n            glyphColor: getContrast(obj.color),\\n            glyph: contentConfig.glyph\\n        });\\n        const waypointMarker = new AdvancedMarkerElement({\\n            map: map,\\n            position: waypointLatLng,\\n            content: pin.element,\\n            title: contentConfig.title + \\": \\" + obj.title,\\n        });\\n        // Add a click listener for each marker, and set up the info window.\\n        waypointMarker.addListener(\\"click\\", function (domEvent) {\\n            const { target } = domEvent;\\n            showOrigenDestinyModal(stats, contentConfig.title == \\"Destino\\" ? true : false);\\n            //showDeliveryInfoModal(delivery, isLastDelivery(index));\\n        });\\n        return marker;\\n    });\\n}\\nfunction loadRoute(routeId) {\\n    return __awaiter(this, void 0, void 0, function* () {\\n        const requestData = new FormData();\\n        requestData.append('id_route', routeId);\\n        try {\\n            const response = yield fetch(\`\${back_url}api/admin/report/seguimiento_list.php\`, {\\n                method: 'POST',\\n                body: requestData,\\n            });\\n            const data = yield response.json();\\n            stats = data.data.seguimiento_list[0];\\n            deliveries = data.data.event_list;\\n            checklist = data.data.checklist;\\n            expenses = data.data.expenses;\\n            if (stats) {\\n                showChecklist = (stats.km_inicial == '0' && stats.gas_inicial == '0');\\n            }\\n            loading = false; // Data loading complete\\n        }\\n        catch (error) {\\n            loading = false; // Data loading complete\\n            console.error('Error fetching data:', error);\\n        }\\n        ;\\n    });\\n}\\nfunction getDeliveryColor(status, service_time = \\"\\") {\\n    let color = '#ffffff';\\n    if (status === 'pending' && !service_time) {\\n        color = '#f2e300';\\n    }\\n    else if (status == \\"pending\\" && service_time) {\\n        color = '#F6A833';\\n    }\\n    else if (status === 'completed') {\\n        color = '#44d900';\\n    }\\n    return color;\\n}\\nfunction getStatusTitle(status) {\\n    let state = '';\\n    if (status == \\"pending\\") {\\n        state = 'Pendiente';\\n    }\\n    else if (status == \\"completed\\") {\\n        state = 'Completado';\\n    }\\n    return state;\\n}\\nfunction getContrast(hexColor) {\\n    // If a leading # is provided, remove it\\n    if (hexColor.slice(0, 1) === '#') {\\n        hexColor = hexColor.slice(1);\\n    }\\n    // If a three-character hexcode, make six-character\\n    if (hexColor.length === 3) {\\n        hexColor = hexColor.split('').map(function (hex) {\\n            return hex + hex;\\n        }).join('');\\n    }\\n    // Convert to RGB value\\n    const r = parseInt(hexColor.substr(0, 2), 16);\\n    const g = parseInt(hexColor.substr(2, 2), 16);\\n    const b = parseInt(hexColor.substr(4, 2), 16);\\n    // Get YIQ ratio\\n    const yiq = ((r * 299) + (g * 587) + (b * 114)) / 1000;\\n    // Check contrast\\n    return (yiq >= 128) ? '#414040' : '#fff';\\n}\\nconst refresh_event_info = (delivery) => {\\n    return new Promise((resolve, reject) => {\\n        const requestData = new FormData();\\n        requestData.append('id_route', delivery.id_route);\\n        requestData.append('id_event', delivery.id_event);\\n        fetch(\`\${back_url}api/admin/evidence/evidence_by_event.php\`, {\\n            method: 'POST',\\n            body: requestData,\\n        })\\n            .then(response => response.json())\\n            .then(data => {\\n            resolve(data.data.event_evidence[0]);\\n        })\\n            .catch(error => {\\n            console.error('Error fetching data:', error);\\n            reject(error);\\n        });\\n    });\\n};\\nconst showDeliveryInfoModal = (delivery, isLast) => {\\n    refresh_event_info(delivery)\\n        .then((evidence_data) => {\\n        //delivery.client_name = stats.client_name;\\n        if (evidence_data) {\\n            //update these two fields that could change when user charge info\\n            delivery.img = evidence_data.img;\\n            delivery.driver_comments = evidence_data.driver_comments;\\n            delivery.comments = evidence_data.comments;\\n        }\\n        IonicShowModal(\\"modal-delivery-info\\", DeliveryInfo, {\\n            delivery, isLast\\n        }).then((result) => {\\n            //console.log(result);\\n        }).finally(() => {\\n            // Modal is closed, now call loadRoute and refresh\\n            loadRoute(routeId);\\n        });\\n    });\\n};\\nconst showOrigenDestinyModal = (stats, isLast) => {\\n    var delivery = new Object();\\n    if (isLast) {\\n        delivery = {\\n            title: stats.destination,\\n            line1: stats.dest_address\\n        };\\n    }\\n    else {\\n        delivery = {\\n            title: stats.origin,\\n            line1: stats.origin_address\\n        };\\n    }\\n    delivery.client_name = stats.client_name;\\n    delivery.client_phone = stats.tel;\\n    delivery.id_route = stats.id_route;\\n    var flag = true; //Flag to know is origen or destiny\\n    IonicShowModal(\\"modal-delivery-info\\", DeliveryInfo, {\\n        delivery, isLast, flag\\n    });\\n};\\nconst showChecklistModal = (checklist, driverId, routeId) => {\\n    var isLast = false;\\n    if (!isModalOpen) {\\n        isModalOpen = true;\\n        IonicShowModal(\\"modal-checklist\\", ChecklistControl, {\\n            checklist, driverId, routeId, isLast\\n        }).then((result) => {\\n            isModalOpen = false;\\n        });\\n        changeRouteStatus(routeId, 'checklist');\\n    }\\n    return \\"\\";\\n};\\nconst showExpenseModal = (routeId) => __awaiter(void 0, void 0, void 0, function* () {\\n    yield loadRoute(routeId);\\n    if (expenses.length > 0) {\\n        IonicShowModal(\\"modal-expense-detail\\", ExpenseDetails, {\\n            routeId, expenses\\n        }).then((result) => {\\n        });\\n    }\\n    else {\\n        IonicShowModal(\\"modal-expense\\", AddExpense, {\\n            routeId\\n        }).then((result) => {\\n        });\\n    }\\n    //changeRouteStatus(routeId,'checklist');\\n    return \\"\\";\\n});\\nconst mustCharge = (delivery) => {\\n    if (delivery.tracking_type == 'subscription') {\\n        if (delivery.subscriber_info && delivery.payment_type === 'cash') {\\n            let date = new Date(delivery.subscriber_info.payment_next);\\n            if (date < (new Date())) {\\n                return true;\\n            }\\n        }\\n    }\\n    else if (delivery.tracking_type == 'ecommerce') {\\n        if (Number(delivery.payment_pending) > 0) {\\n            return true;\\n        }\\n    }\\n    return false;\\n};\\nfunction changeRouteStatus(id_route, status) {\\n    let requestData = new FormData();\\n    requestData.append('id_route', id_route);\\n    requestData.append('status', status);\\n    fetch(\`\${back_url}api/admin/route/change_status.php\`, {\\n        method: 'POST',\\n        body: requestData,\\n    })\\n        .then(response => response.json())\\n        .then(data => {\\n    })\\n        .catch(error => {\\n        console.error('Error fetching data:', error);\\n    });\\n    return \\"\\";\\n}\\nconst goBack = () => {\\n    // Redirect to backpage\\n    if (dataSession.type == \\"super\\" || dataSession.type == \\"admin\\") {\\n        goto(\`/drivers/me\`);\\n    }\\n    else if (dataSession.id_driver) {\\n        goto(\`/drivers/\${dataSession.id_driver}\`);\\n    }\\n};\\nconst showAlert = (customHeader, customMessage) => __awaiter(void 0, void 0, void 0, function* () {\\n    const alert = yield alertController.create({\\n        header: customHeader || 'Error', // Use customHeader or default value\\n        message: customMessage || 'Vuelva a intentar', // Use customMessage or default value\\n        buttons: [\\n            {\\n                text: 'Cerrar'\\n            }\\n        ]\\n    });\\n    yield alert.present();\\n});\\nfunction isLastDelivery(index) {\\n    return index === deliveries.length - 1;\\n}\\n<\/script>\\n\\n<style>\\n\\n    .sub {\\n        font-size: 12px;\\n        margin-top: 5px;\\n    }\\n\\n    .order-wrapper {\\n        width: 100%;\\n        height: 100%;\\n        border-radius: 50%;\\n        border: 1px solid #CBCFDE;\\n        text-align: center;\\n        display: flex;\\n        justify-content: center;\\n    }\\n\\n    .order {\\n        align-self: center;\\n    }\\n\\n    .notes {\\n        background-color: #e0b500;\\n        display: inline-block;\\n        width: 8px;\\n        height: 8px;\\n        border-radius: 50%;\\n    }\\n    #map {\\n        height: 400px;\\n        width: 100%;\\n    }\\n</style>\\n\\n<svelte:head>\\n    <title>Rutaflow - Detalles de ruta</title>\\n</svelte:head>\\n\\n{#if dataSession}\\n    <IonPage>\\n        <ion-header translucent>\\n            <ion-toolbar>\\n                <ion-buttons slot=\\"start\\">\\n                    <ion-button title=\\"Atrás\\" alt=\\"Atrás\\" on:click={goBack}><ion-icon icon={arrowBack}></ion-icon></ion-button>\\n                </ion-buttons>\\n                <ion-buttons slot=\\"end\\">\\n                    <ion-button on:click={()=>showExpenseModal(routeId)}><ion-icon icon={cashOutline}></ion-icon></ion-button>\\n                    <!-- <ion-button>{dataSession.name}</ion-button> -->\\n                </ion-buttons>\\n        \\n                <ion-title>{stats.name ? stats.name.toUpperCase() : ''}</ion-title>\\n        \\n            </ion-toolbar>\\n            <!-- Tabs for switching between List and Map -->\\n            <ion-segment value=\\"list\\" on:ionChange={e => setSegmentValue(e.detail.value)}>\\n                <ion-segment-button value=\\"list\\">\\n                    <ion-label>Paradas</ion-label>\\n                </ion-segment-button>\\n                <ion-segment-button value=\\"map\\">\\n                    <ion-label>Mapa</ion-label>\\n                </ion-segment-button>\\n            </ion-segment>\\n        </ion-header>\\n        <!-- Conditional rendering based on the selected tab -->\\n        {#if segmentValue === \\"list\\"}\\n            {#if checklist.length > 0}\\n                {#if checklist.filter(item => item.mandatory === \\"1\\").every(item => item.img) && !showChecklist}\\n                    <ion-content>\\n                        <ion-refresher slot=\\"fixed\\" bind:this={refresher} on:ionRefresh={refresh}>\\n                            <ion-refresher-content pulling-icon=\\"arrow-dropdown\\"\\n                                                pulling-text=\\"Jale para actualizar\\"\\n                                                refreshing-spinner=\\"circles\\"\\n                                                refreshing-text=\\"Actualizando...\\"></ion-refresher-content>\\n                        </ion-refresher>\\n                        <ion-list>\\n                            <ion-item>\\n                                <ion-avatar slot=\\"start\\">\\n                                    <div class=\\"order-wrapper\\" title=\\"\${stats.origin}\\" style=\\"background-color: {stats.color}; color: {getContrast(stats.color)}\\">\\n                                        <div class=\\"order\\">\\n                                            0\\n                                        </div>\\n                                    </div>\\n                                </ion-avatar>\\n                                <ion-label button on:click={() => {showOrigenDestinyModal(stats, false)}}>\\n\\n                                    <ion-text color=\\"#2e2e2e\\">\\n                                        <h3>\\n                                            {stats.origin}\\n                                        </h3>\\n                                    </ion-text>\\n                                    <div class=\\"sub\\">\\n\\n                                    </div>\\n                                </ion-label>\\n                                <ion-icon icon={locationOutline} slot=\\"end\\"></ion-icon>\\n                            </ion-item>\\n                            {#each deliveries as delivery, index (delivery.id_event)}\\n                                <ion-item>\\n                                    <ion-avatar slot=\\"start\\">\\n                                        <div class=\\"order-wrapper\\" title=\\"{getStatusTitle(delivery.status)}\\" style=\\"background-color: {getDeliveryColor(delivery.status,delivery.date_service)}; color: {getContrast(getDeliveryColor(delivery.status))}\\">\\n                                            <div class=\\"order\\">\\n                                                {parseInt(delivery.pos) + 1}\\n                                            </div>\\n                                        </div>\\n                                    </ion-avatar>\\n                                    <ion-label button on:click={() => {\\n                                        // Get the index of the current delivery in the array\\n                                        const currentIndex = deliveries.findIndex(item => item.id_event === delivery.id_event);\\n                                        \\n                                        // Check if the previous delivery has an image (or if it's the first delivery)\\n                                        const isFirstDelivery = currentIndex === 0;\\n                                        const previousDelivery = currentIndex > 0 ? deliveries[currentIndex - 1] : null;\\n                                        const previousDeliveryHasImage = isFirstDelivery || (previousDelivery && previousDelivery.img !== null);\\n                                        \\n                                        // Check if the current delivery has an image\\n                                        const currentDeliveryHasImage = delivery.img !== null && delivery.img !== '';\\n                                        \\n                                        // Allow showing the modal only if the current delivery has an image\\n                                        // or if it's the first delivery and the current delivery does not have an image\\n                                        if (previousDeliveryHasImage || (isFirstDelivery && !currentDeliveryHasImage)) {\\n                                            showDeliveryInfoModal(delivery, false);\\n                                        } else {\\n                                            showAlert(\\"Información incompleta\\", \\"No puedes visualizar otras paradas hasta cargar evidencia del destino pasado\\");\\n                                        }\\n                                    }}>\\n                                    <!-- <ion-label button on:click={() => showDeliveryInfoModal(delivery, isLastDelivery(index))}> -->\\n                                        <ion-text color=\\"#2e2e2e\\">\\n                                            <h3>\\n                                                {delivery.title}\\n                                                {#if (delivery.support_list && delivery.support_list.length) || mustCharge(delivery)}\\n                                                    <span class=\\"notes\\"></span>\\n                                                {/if}\\n                                            </h3>\\n                                        </ion-text>\\n                                        <div class=\\"sub\\">\\n                                            <!-- <BoxesCount delivery={delivery} /> -->\\n\\n                                        </div>\\n                                    </ion-label>\\n                                    <ion-icon icon={locationOutline} slot=\\"end\\"></ion-icon>\\n                                </ion-item>\\n                            {/each}\\n                            <ion-item>\\n                                <ion-avatar slot=\\"start\\">\\n                                    <div class=\\"order-wrapper\\" title=\\"\${stats.destination}\\" style=\\"background-color: {stats.color}; color: {getContrast(stats.color)}\\">\\n                                        <div class=\\"order\\">\\n                                            {deliveries.length + 1}\\n                                        </div>\\n                                    </div>\\n                                </ion-avatar>\\n                                <ion-label button on:click={() => {showOrigenDestinyModal(stats, true)}}>\\n                                <!-- <ion-label button on:click={() => showDeliveryInfoModal(delivery, isLastDelivery(index))}> -->\\n                                    <ion-text color=\\"#2e2e2e\\">\\n                                        <h3>\\n                                            {stats.destination}\\n                                        </h3>\\n                                    </ion-text>\\n                                    <div class=\\"sub\\">\\n                                        <!-- <BoxesCount delivery={delivery} /> -->\\n\\n                                    </div>\\n                                </ion-label>\\n                                <ion-icon icon={locationOutline} slot=\\"end\\"></ion-icon>\\n                            </ion-item>\\n                        </ion-list>\\n                    </ion-content>\\n                {:else}\\n                    {showChecklistModal(checklist,driverId,routeId)}\\n                    <ion-content>\\n                        <ion-refresher slot=\\"fixed\\" bind:this={refresher} on:ionRefresh={refresh}>\\n                            <ion-refresher-content pulling-icon=\\"arrow-dropdown\\"\\n                                                pulling-text=\\"Pull to refresh\\"\\n                                                refreshing-spinner=\\"circles\\"\\n                                                refreshing-text=\\"Refreshing...\\"></ion-refresher-content>\\n                        </ion-refresher>\\n                        <ion-list>\\n                            {#each deliveries as delivery, index (delivery.id_event)}\\n                                <ion-item>\\n                                    <ion-avatar slot=\\"start\\">\\n                                        <div class=\\"order-wrapper\\" title=\\"{getStatusTitle(delivery.status)}\\" style=\\"background-color: {getDeliveryColor(delivery.status, delivery.date_service)}; color: {getContrast(getDeliveryColor(delivery.status))}\\">\\n                                            <div class=\\"order\\">\\n                                                {parseInt(delivery.pos) + 1}\\n                                            </div>\\n                                        </div>\\n                                    </ion-avatar>\\n                                    <ion-label button on:click={() => {\\n                                        // Get the index of the current delivery in the array\\n                                        const currentIndex = deliveries.findIndex(item => item.id_event === delivery.id_event);\\n                                        \\n                                        // Check if the previous delivery has an image (or if it's the first delivery)\\n                                        const isFirstDelivery = currentIndex === 0;\\n                                        const previousDelivery = currentIndex > 0 ? deliveries[currentIndex - 1] : null;\\n                                        const previousDeliveryHasImage = isFirstDelivery || (previousDelivery && previousDelivery.img !== null);\\n                                        \\n                                        // Check if the current delivery has an image\\n                                        const currentDeliveryHasImage = delivery.img !== null && delivery.img !== '';\\n                                        \\n                                        // Allow showing the modal only if the current delivery has an image\\n                                        // or if it's the first delivery and the current delivery does not have an image\\n                                        if (previousDeliveryHasImage || (isFirstDelivery && !currentDeliveryHasImage)) {\\n                                            showDeliveryInfoModal(delivery, isLastDelivery(index));\\n                                        } else {\\n                                            showAlert(\\"Información incompleta\\", \\"No puedes visualizar otras paradas hasta cargar evidencia del destino pasado\\");\\n                                        }\\n                                    }}>\\n                                    <!-- <ion-label button on:click={() => showDeliveryInfoModal(delivery, isLastDelivery(index))}> -->\\n                                        <ion-text color=\\"#2e2e2e\\">\\n                                            <h3>\\n                                                {delivery.title}\\n                                                {#if (delivery.support_list && delivery.support_list.length) || mustCharge(delivery)}\\n                                                    <span class=\\"notes\\"></span>\\n                                                {/if}\\n                                            </h3>\\n                                        </ion-text>\\n                                        <div class=\\"sub\\">\\n                                            <!-- <BoxesCount delivery={delivery} /> -->\\n\\n                                        </div>\\n                                    </ion-label>\\n                                    <ion-icon icon={locationOutline} slot=\\"end\\"></ion-icon>\\n                                </ion-item>\\n                            {/each}\\n                        </ion-list>\\n                    </ion-content>\\n                {/if}\\n            {:else}\\n                {#if !loading}\\n                    {#if showChecklist}\\n                        {showChecklistModal(\\"\\",driverId,routeId)}\\n                    {/if}\\n                    <ion-content>\\n                        <ion-refresher slot=\\"fixed\\" bind:this={refresher} on:ionRefresh={refresh}>\\n                            <ion-refresher-content pulling-icon=\\"arrow-dropdown\\"\\n                                                pulling-text=\\"Jala para actualizar\\"\\n                                                refreshing-spinner=\\"circles\\"\\n                                                refreshing-text=\\"Actualizando...\\"></ion-refresher-content>\\n                        </ion-refresher>\\n                        <ion-list>\\n                            {#each deliveries as delivery, index (delivery.id_event)}\\n                                <ion-item>\\n                                    <ion-avatar slot=\\"start\\">\\n                                        <div class=\\"order-wrapper\\" title=\\"{getStatusTitle(delivery.status)}\\" style=\\"background-color: {getDeliveryColor(delivery.status, delivery.date_service)}; color: {getContrast(getDeliveryColor(delivery.status))}\\">\\n                                            <div class=\\"order\\">\\n                                                {parseInt(delivery.pos) + 1}\\n                                            </div>\\n                                        </div>\\n                                    </ion-avatar>\\n                                    <ion-label button on:click={() => {\\n                                        // Get the index of the current delivery in the array\\n                                        const currentIndex = deliveries.findIndex(item => item.id_event === delivery.id_event);\\n                                        \\n                                        // Check if the previous delivery has an image (or if it's the first delivery)\\n                                        const isFirstDelivery = currentIndex === 0;\\n                                        const previousDelivery = currentIndex > 0 ? deliveries[currentIndex - 1] : null;\\n                                        const previousDeliveryHasImage = isFirstDelivery || (previousDelivery && previousDelivery.img !== null);\\n                                        \\n                                        // Check if the current delivery has an image\\n                                        const currentDeliveryHasImage = delivery.img !== null && delivery.img !== '';\\n                                        \\n                                        // Allow showing the modal only if the current delivery has an image\\n                                        // or if it's the first delivery and the current delivery does not have an image\\n                                        if (previousDeliveryHasImage || (isFirstDelivery && !currentDeliveryHasImage)) {\\n                                            showDeliveryInfoModal(delivery, isLastDelivery(index));\\n                                        } else {\\n                                            showAlert(\\"Información incompleta\\", \\"No puedes visualizar otras paradas hasta cargar evidencia del destino pasado\\");\\n                                        }\\n                                    }}>                            \\n                                        <ion-text color=\\"#2e2e2e\\">\\n                                            <h3>\\n                                                {delivery.title}\\n                                                {#if (delivery.support_list && delivery.support_list.length) || mustCharge(delivery)}\\n                                                    <span class=\\"notes\\"></span>\\n                                                {/if}\\n                                            </h3>\\n                                        </ion-text>\\n                                    </ion-label>\\n                                    <ion-icon icon={locationOutline} slot=\\"end\\" style=\\"color: {getDeliveryColor(delivery.status,delivery.date_service)}\\"></ion-icon>\\n                                </ion-item>\\n                            {/each}\\n                        </ion-list>\\n                    </ion-content>\\n                {/if}\\n            {/if}\\n        {:else if segmentValue === \\"map\\"}\\n            <!-- Google Maps View -->\\n            <ion-content>\\n                <!-- HTML where the map will render -->\\n                <div id=\\"g_map\\" style=\\"width: 100%; height: 100vh;\\"></div>\\n            </ion-content>\\n        {/if}\\n    </IonPage>\\n{/if}"],"names":[],"mappings":"AA8ZI,kBAAK,CACD,SAAS,CAAE,IAAI,CACf,UAAU,CAAE,GAChB,CAEA,4BAAe,CACX,KAAK,CAAE,IAAI,CACX,MAAM,CAAE,IAAI,CACZ,aAAa,CAAE,GAAG,CAClB,MAAM,CAAE,GAAG,CAAC,KAAK,CAAC,OAAO,CACzB,UAAU,CAAE,MAAM,CAClB,OAAO,CAAE,IAAI,CACb,eAAe,CAAE,MACrB,CAEA,oBAAO,CACH,UAAU,CAAE,MAChB,CAEA,oBAAO,CACH,gBAAgB,CAAE,OAAO,CACzB,OAAO,CAAE,YAAY,CACrB,KAAK,CAAE,GAAG,CACV,MAAM,CAAE,GAAG,CACX,aAAa,CAAE,GACnB"}`
};
function getDeliveryColor(status, service_time = "") {
  let color = "#ffffff";
  if (status === "pending" && !service_time) {
    color = "#f2e300";
  } else if (status == "pending" && service_time) {
    color = "#F6A833";
  } else if (status === "completed") {
    color = "#44d900";
  }
  return color;
}
function getStatusTitle(status) {
  let state = "";
  if (status == "pending") {
    state = "Pendiente";
  } else if (status == "completed") {
    state = "Completado";
  }
  return state;
}
function getContrast(hexColor) {
  if (hexColor.slice(0, 1) === "#") {
    hexColor = hexColor.slice(1);
  }
  if (hexColor.length === 3) {
    hexColor = hexColor.split("").map(function(hex) {
      return hex + hex;
    }).join("");
  }
  const r = parseInt(hexColor.substr(0, 2), 16);
  const g = parseInt(hexColor.substr(2, 2), 16);
  const b = parseInt(hexColor.substr(4, 2), 16);
  const yiq = (r * 299 + g * 587 + b * 114) / 1e3;
  return yiq >= 128 ? "#414040" : "#fff";
}
const Page = create_ssr_component(($$result, $$props, $$bindings, slots) => {
  let $page, $$unsubscribe_page;
  $$unsubscribe_page = subscribe(page, (value) => $page = value);
  var __awaiter = function(thisArg, _arguments, P, generator) {
    function adopt(value) {
      return value instanceof P ? value : new P(function(resolve) {
        resolve(value);
      });
    }
    return new (P || (P = Promise))(function(resolve, reject) {
      function fulfilled(value) {
        try {
          step(generator.next(value));
        } catch (e) {
          reject(e);
        }
      }
      function rejected(value) {
        try {
          step(generator["throw"](value));
        } catch (e) {
          reject(e);
        }
      }
      function step(result) {
        result.done ? resolve(result.value) : adopt(result.value).then(fulfilled, rejected);
      }
      step((generator = generator.apply(thisArg, [])).next());
    });
  };
  let { routeId } = $$props;
  let { driverId } = $$props;
  let back_url = DATABASE_URL;
  let dataSession = new Object();
  let loading = true;
  let showChecklist = false;
  let deliveries = [];
  let stats = {};
  let checklist = [];
  let expenses = [];
  let refresher;
  let isModalOpen = false;
  function loadRoute(routeId2) {
    return __awaiter(this, void 0, void 0, function* () {
      const requestData = new FormData();
      requestData.append("id_route", routeId2);
      try {
        const response = yield fetch(`${back_url}api/admin/report/seguimiento_list.php`, { method: "POST", body: requestData });
        const data = yield response.json();
        stats = data.data.seguimiento_list[0];
        deliveries = data.data.event_list;
        checklist = data.data.checklist;
        expenses = data.data.expenses;
        if (stats) {
          showChecklist = stats.km_inicial == "0" && stats.gas_inicial == "0";
        }
        loading = false;
      } catch (error) {
        loading = false;
        console.error("Error fetching data:", error);
      }
    });
  }
  const showChecklistModal = (checklist2, driverId2, routeId2) => {
    var isLast = false;
    if (!isModalOpen) {
      isModalOpen = true;
      IonicShowModal("modal-checklist", ChecklistControl, { checklist: checklist2, driverId: driverId2, routeId: routeId2, isLast }).then((result) => {
        isModalOpen = false;
      });
      changeRouteStatus(routeId2, "checklist");
    }
    return "";
  };
  const mustCharge = (delivery) => {
    if (delivery.tracking_type == "subscription") {
      if (delivery.subscriber_info && delivery.payment_type === "cash") {
        let date = new Date(delivery.subscriber_info.payment_next);
        if (date < /* @__PURE__ */ new Date()) {
          return true;
        }
      }
    } else if (delivery.tracking_type == "ecommerce") {
      if (Number(delivery.payment_pending) > 0) {
        return true;
      }
    }
    return false;
  };
  function changeRouteStatus(id_route, status) {
    let requestData = new FormData();
    requestData.append("id_route", id_route);
    requestData.append("status", status);
    fetch(`${back_url}api/admin/route/change_status.php`, { method: "POST", body: requestData }).then((response) => response.json()).then((data) => {
    }).catch((error) => {
      console.error("Error fetching data:", error);
    });
    return "";
  }
  if ($$props.routeId === void 0 && $$bindings.routeId && routeId !== void 0) $$bindings.routeId(routeId);
  if ($$props.driverId === void 0 && $$bindings.driverId && driverId !== void 0) $$bindings.driverId(driverId);
  $$result.css.add(css);
  {
    {
      ({ routeId, driverId } = $page.params);
      dataSession = JSON.parse(localStorage.getItem("userSession"));
      if (dataSession) {
        if (dataSession.id_user && (dataSession.type == "admin" || dataSession.type == "super")) {
          loadRoute(routeId);
          goto();
        } else if (dataSession.id_user && dataSession.id_driver) {
          loadRoute(routeId);
          goto(`/drivers/${dataSession.id_driver}/routes/${routeId}`);
        }
      } else {
        goto();
      }
    }
  }
  $$unsubscribe_page();
  return `${$$result.head += `<!-- HEAD_svelte-kn0kph_START -->${$$result.title = `<title>Rutaflow - Detalles de ruta</title>`, ""}<!-- HEAD_svelte-kn0kph_END -->`, ""} ${dataSession ? `${validate_component(IonPage, "IonPage").$$render($$result, {}, {}, {
    default: () => {
      return `<ion-header translucent><ion-toolbar><ion-buttons slot="start"><ion-button title="Atrás" alt="Atrás" data-svelte-h="svelte-7ppz3r"><ion-icon${add_attribute("icon", arrowBack, 0)}></ion-icon></ion-button></ion-buttons> <ion-buttons slot="end"><ion-button data-svelte-h="svelte-nf50hj"><ion-icon${add_attribute("icon", cashOutline, 0)}></ion-icon></ion-button> </ion-buttons> <ion-title>${escape(stats.name ? stats.name.toUpperCase() : "")}</ion-title></ion-toolbar>  <ion-segment value="list" data-svelte-h="svelte-lue4c9"><ion-segment-button value="list"><ion-label>Paradas</ion-label></ion-segment-button> <ion-segment-button value="map"><ion-label>Mapa</ion-label></ion-segment-button></ion-segment></ion-header>  ${`${checklist.length > 0 ? `${checklist.filter((item) => item.mandatory === "1").every((item) => item.img) && !showChecklist ? `<ion-content><ion-refresher slot="fixed"${add_attribute("this", refresher, 0)} data-svelte-h="svelte-15ukrgn"><ion-refresher-content pulling-icon="arrow-dropdown" pulling-text="Jale para actualizar" refreshing-spinner="circles" refreshing-text="Actualizando..."></ion-refresher-content></ion-refresher> <ion-list><ion-item><ion-avatar slot="start"><div class="order-wrapper svelte-egzizz" title="${"$" + escape(stats.origin, true)}" style="${"background-color: " + escape(stats.color, true) + "; color: " + escape(getContrast(stats.color), true)}"><div class="order svelte-egzizz" data-svelte-h="svelte-3lvlrb">0</div></div></ion-avatar> <ion-label button><ion-text color="#2e2e2e"><h3>${escape(stats.origin)}</h3></ion-text> <div class="sub svelte-egzizz" data-svelte-h="svelte-gz9kb"></div></ion-label> <ion-icon${add_attribute("icon", locationOutline, 0)} slot="end"></ion-icon></ion-item> ${each(deliveries, (delivery, index) => {
        return `<ion-item><ion-avatar slot="start"><div class="order-wrapper svelte-egzizz"${add_attribute("title", getStatusTitle(delivery.status), 0)} style="${"background-color: " + escape(getDeliveryColor(delivery.status, delivery.date_service), true) + "; color: " + escape(getContrast(getDeliveryColor(delivery.status)), true)}"><div class="order svelte-egzizz">${escape(parseInt(delivery.pos) + 1)}</div> </div></ion-avatar> <ion-label button> <ion-text color="#2e2e2e"><h3>${escape(delivery.title)} ${delivery.support_list && delivery.support_list.length || mustCharge(delivery) ? `<span class="notes svelte-egzizz"></span>` : ``} </h3></ion-text> <div class="sub svelte-egzizz" data-svelte-h="svelte-qaecoo"> </div></ion-label> <ion-icon${add_attribute("icon", locationOutline, 0)} slot="end"></ion-icon> </ion-item>`;
      })} <ion-item><ion-avatar slot="start"><div class="order-wrapper svelte-egzizz" title="${"$" + escape(stats.destination, true)}" style="${"background-color: " + escape(stats.color, true) + "; color: " + escape(getContrast(stats.color), true)}"><div class="order svelte-egzizz">${escape(deliveries.length + 1)}</div></div></ion-avatar> <ion-label button> <ion-text color="#2e2e2e"><h3>${escape(stats.destination)}</h3></ion-text> <div class="sub svelte-egzizz" data-svelte-h="svelte-130ohbs"></div></ion-label> <ion-icon${add_attribute("icon", locationOutline, 0)} slot="end"></ion-icon></ion-item></ion-list></ion-content>` : `${escape(showChecklistModal(checklist, driverId, routeId))} <ion-content><ion-refresher slot="fixed"${add_attribute("this", refresher, 0)} data-svelte-h="svelte-dvt1s"><ion-refresher-content pulling-icon="arrow-dropdown" pulling-text="Pull to refresh" refreshing-spinner="circles" refreshing-text="Refreshing..."></ion-refresher-content></ion-refresher> <ion-list>${each(deliveries, (delivery, index) => {
        return `<ion-item><ion-avatar slot="start"><div class="order-wrapper svelte-egzizz"${add_attribute("title", getStatusTitle(delivery.status), 0)} style="${"background-color: " + escape(getDeliveryColor(delivery.status, delivery.date_service), true) + "; color: " + escape(getContrast(getDeliveryColor(delivery.status)), true)}"><div class="order svelte-egzizz">${escape(parseInt(delivery.pos) + 1)}</div> </div></ion-avatar> <ion-label button> <ion-text color="#2e2e2e"><h3>${escape(delivery.title)} ${delivery.support_list && delivery.support_list.length || mustCharge(delivery) ? `<span class="notes svelte-egzizz"></span>` : ``} </h3></ion-text> <div class="sub svelte-egzizz" data-svelte-h="svelte-qaecoo"> </div></ion-label> <ion-icon${add_attribute("icon", locationOutline, 0)} slot="end"></ion-icon> </ion-item>`;
      })}</ion-list></ion-content>`}` : `${!loading ? `${showChecklist ? `${escape(showChecklistModal("", driverId, routeId))}` : ``} <ion-content><ion-refresher slot="fixed"${add_attribute("this", refresher, 0)} data-svelte-h="svelte-1srnbs3"><ion-refresher-content pulling-icon="arrow-dropdown" pulling-text="Jala para actualizar" refreshing-spinner="circles" refreshing-text="Actualizando..."></ion-refresher-content></ion-refresher> <ion-list>${each(deliveries, (delivery, index) => {
        return `<ion-item><ion-avatar slot="start"><div class="order-wrapper svelte-egzizz"${add_attribute("title", getStatusTitle(delivery.status), 0)} style="${"background-color: " + escape(getDeliveryColor(delivery.status, delivery.date_service), true) + "; color: " + escape(getContrast(getDeliveryColor(delivery.status)), true)}"><div class="order svelte-egzizz">${escape(parseInt(delivery.pos) + 1)}</div> </div></ion-avatar> <ion-label button><ion-text color="#2e2e2e"><h3>${escape(delivery.title)} ${delivery.support_list && delivery.support_list.length || mustCharge(delivery) ? `<span class="notes svelte-egzizz"></span>` : ``}</h3> </ion-text></ion-label> <ion-icon${add_attribute("icon", locationOutline, 0)} slot="end" style="${"color: " + escape(getDeliveryColor(delivery.status, delivery.date_service), true)}"></ion-icon> </ion-item>`;
      })}</ion-list></ion-content>` : ``}`}`}`;
    }
  })}` : ``}`;
});

export { Page as default };
//# sourceMappingURL=_page.svelte-BUsjNgSn.js.map
