import { c as create_ssr_component, d as subscribe, v as validate_component, a as add_attribute, e as escape, f as each } from './ssr-BvR1n3wf.js';
import { alertController, modalController } from '@ionic/core';
import { arrowBack, warningOutline, cashOutline, locationOutline } from 'ionicons/icons/index.mjs';
import { defineCustomElement } from '@ionic/core/components/ion-modal.js';
import { initialize } from '@ionic/core/components/index.js';
import { g as goto } from './client-DpIAX_q0.js';
import { DATABASE_URL } from './hooks-Dl6gdxn6.js';
import { p as page, I as IonPage, h as hexToRGBA } from './index2-CjcmD9z0.js';
import 'signature_pad';
import './exports-BGi7-Rnc.js';

const registerCustomElement = (tagName, component) => {
  if (!customElements.get(tagName)) {
    class SvelteElement extends HTMLElement {
      constructor() {
        super();
        this.attachShadow({ mode: "open" });
      }
      connectedCallback() {
        new component({
          target: this.shadowRoot,
          props: this.componentProps || {}
        });
      }
    }
    customElements.define(tagName, SvelteElement);
  }
};
const isRegistered = (name) => document.createElement(name).constructor !== HTMLElement;
const registerWebComponentOnce = (selector, component) => {
  if (!isRegistered(selector)) {
    registerCustomElement(selector, component);
  }
};
const IonicShowModal = async (selector, component, componentProps = {}, modalOptions = {}) => {
  initialize();
  defineCustomElement();
  registerWebComponentOnce(selector, component);
  const modal = await modalController.create({
    component: selector,
    componentProps,
    // sigue funcionando para Ionic, pero Svelte leerÃ¡ `el.componentProps`
    ...modalOptions
  });
  modal.addEventListener("ionModalDidPresent", () => {
    const el = modal.querySelector(selector);
    if (el) el.componentProps = componentProps;
  });
  await modal.present();
  return modal.onWillDismiss();
};
const ChecklistControl = create_ssr_component(($$result, $$props, $$bindings, slots) => {
  let checklist = [];
  let checkk = [];
  let checkbox_item = {};
  let KmInicial, GasInicial;
  let loadingStates = {};
  let imagesName = {};
  return `<ion-header translucent><ion-toolbar><ion-buttons slot="start"><ion-button color="medium" data-svelte-h="svelte-18837zq">Cancelar</ion-button></ion-buttons> <ion-title data-svelte-h="svelte-19bar5p">REQUERIMIENTOS DE RUTA</ion-title></ion-toolbar></ion-header> <ion-content fullscreen><ion-list>${`<ion-item><ion-label style="display:flex;"><input${add_attribute("id", `chkbox-km-ini`, 0)} style="pointer-events: auto;" type="checkbox" required${add_attribute("this", KmInicial, 0)}> <p style="margin-left:10px;" data-svelte-h="svelte-88twxi">Kilometraje inicial</p></ion-label> <ion-button fill="outline" size="small" class="loadKmInicial" aria-selected>${escape("Cargar km")}</ion-button></ion-item> <ion-item><ion-label style="display:flex;"><input${add_attribute("id", `chkbox-gas-ini`, 0)} style="pointer-events: auto;" type="checkbox" required${add_attribute("this", GasInicial, 0)}> <p style="margin-left:10px;" data-svelte-h="svelte-1ux30eb">Gasolina inicial (litros)</p></ion-label> <ion-button fill="outline" class="loadGasInicial" size="small" style="height: 16px ">${escape("Cargar gas")}</ion-button></ion-item>`} ${checklist ? `${each(checklist, (check) => {
    return `<ion-item><ion-label style="display:flex;"><input${add_attribute("id", `chkbox-${check.id_checklist_event}`, 0)} style="pointer-events: auto;" type="checkbox"${add_attribute("value", check.id_checklist_event, 0)} required${~checkk.indexOf(check.id_checklist_event) ? add_attribute("checked", true, 1) : ""}${add_attribute("this", checkbox_item[check.id_checklist_event], 0)}> <p style="margin-left:10px;">${escape(check.item)}</p> <b style="margin-left:5px;">${escape(check.mandatory == "1" ? " * " : "")} </b></ion-label> <ion-button fill="outline" class="loadEvidence" size="small"><div class="button-content">${loadingStates[check.id_checklist_event] ? `<ion-spinner name="dots" class="button-spinner"></ion-spinner>` : `<label for="${"chklist-" + escape(check.id_checklist_event, true)}" class="button-label">${escape(imagesName[check.id_checklist_event] ? imagesName[check.id_checklist_event] : "Cargar evidencia")} </label>`} <input style="display:none;" id="${"chklist-" + escape(check.id_checklist_event, true)}" name="fileToUpload" type="file" accept="image/*" capture="environment"> </div></ion-button> </ion-item>`;
  })}` : ``}</ion-list></ion-content>  <ion-footer><ion-button fill="outline" color="tertiary" strong style="width: 99%; height: auto; margin-bottom: 120px;" data-svelte-h="svelte-1vqzxem">Confirmar</ion-button></ion-footer> ${``}`;
});
const css = {
  code: ".sub.svelte-1ita8l7{font-size:12px;margin-top:5px}.order-wrapper.svelte-1ita8l7{width:100%;height:100%;border-radius:50%;border:1px solid #cbcfde;text-align:center;display:flex;justify-content:center}.order.svelte-1ita8l7{align-self:center}.notes.svelte-1ita8l7{background-color:#e0b500;display:inline-block;width:8px;height:8px;border-radius:50%}",
  map: '{"version":3,"file":"+page.svelte","sources":["+page.svelte"],"sourcesContent":["<script lang=\\"ts\\">var __awaiter = (this && this.__awaiter) || function (thisArg, _arguments, P, generator) {\\n    function adopt(value) { return value instanceof P ? value : new P(function (resolve) { resolve(value); }); }\\n    return new (P || (P = Promise))(function (resolve, reject) {\\n        function fulfilled(value) { try { step(generator.next(value)); } catch (e) { reject(e); } }\\n        function rejected(value) { try { step(generator[\\"throw\\"](value)); } catch (e) { reject(e); } }\\n        function step(result) { result.done ? resolve(result.value) : adopt(result.value).then(fulfilled, rejected); }\\n        step((generator = generator.apply(thisArg, _arguments || [])).next());\\n    });\\n};\\nexport let routeId;\\nexport let driverId;\\nimport DeliveryInfo from \\"./_DeliveryInfo.svelte\\";\\nimport IonPage from \\"ionic-svelte/components/IonPage.svelte\\";\\nimport ChecklistControl from \\"./_ChecklistControl.svelte\\";\\nimport AddExpense from \\"./_AddExpense.svelte\\";\\nimport AddIncidence from \\"./_AddIncidence.svelte\\";\\nimport ExpenseDetails from \\"./_ExpenseDetails.svelte\\";\\nimport { onMount, tick } from \\"svelte\\";\\nimport { IonicShowModal } from \\"../../../../../services/IonicControllers\\";\\nimport { alertController } from \\"@ionic/core\\";\\nimport { page } from \\"$app/stores\\";\\nimport { goto } from \\"$app/navigation\\";\\nimport { locationOutline, cashOutline, warningOutline, } from \\"ionicons/icons\\";\\nimport { arrowBack } from \\"ionicons/icons\\";\\nimport { DATABASE_URL } from \\"../../../../../hooks\\";\\nimport { hexToRGBA } from \\"$lib\\";\\n/*Back URL*/\\nlet back_url = DATABASE_URL;\\nlet dataSession = new Object();\\nlet loading = true;\\nlet showChecklist = false;\\nlet deliveries = [];\\nlet incidences = [];\\nlet stats = {};\\nlet checklist = [];\\nlet expenses = [];\\nlet refresher;\\nlet isModalOpen = false;\\nlet segmentValue = \\"list\\"; // Controls the tab selection\\nlet mapElement;\\nlet stopsApproval = \\"\\";\\nlet smsActive = \\"\\";\\nlet signatureActive = \\"\\";\\nlet orderRestriction = \\"0\\";\\nlet settings = new Object();\\nlet deliveryInfoModalPromise = \\"\\";\\nlet isLoading = false;\\nlet showStartButton = false; // mostrarÃ¡ el botÃ³n tras \\"Previsualizar\\"\\nlet routeStarted = false; // NUEVO: para controlar el cambio de color\\n// NUEVO: para no repetir la advertencia cada vez\\nlet checklistWarnShown = false;\\nlet alertInProgress = false; // para evitar mÃºltiples alerts\\nconst motiveIconName = {\\n    car_accident: \\"/car-accident.svg\\",\\n    restaurant: \\"/restaurant.svg\\",\\n    parking: \\"/parking.svg\\",\\n    hospital: \\"/hospital.svg\\", // svg externo\\n    wc: \\"/toilet.svg\\", // svg externo\\n    traffic: \\"/traffic.svg\\", // svg externo\\n};\\nconst refresh = () => __awaiter(void 0, void 0, void 0, function* () {\\n    // Resetear la advertencia al refrescar para que pueda aparecer de nuevo\\n    checklistWarnShown = false;\\n    yield loadRoute(routeId);\\n    refresher.complete();\\n});\\nonMount(() => __awaiter(void 0, void 0, void 0, function* () {\\n    // Resetear la advertencia al cargar la pÃ¡gina\\n    checklistWarnShown = false;\\n    checkSettings();\\n    yield loadRoute(routeId);\\n}));\\n$: {\\n    ({ routeId, driverId } = $page.params);\\n    // Resetear la advertencia cuando cambian los parÃ¡metros\\n    checklistWarnShown = false;\\n    dataSession = JSON.parse(localStorage.getItem(\\"userSession\\"));\\n    if (dataSession) {\\n        if (dataSession.id_user &&\\n            (dataSession.type == \\"admin\\" || dataSession.type == \\"super\\")) {\\n            loadRoute(routeId);\\n            goto(`/drivers/me/routes/${routeId}`);\\n        }\\n        else if (dataSession.id_user && dataSession.id_driver) {\\n            loadRoute(routeId);\\n            goto(`/drivers/${dataSession.id_driver}/routes/${routeId}`);\\n        }\\n    }\\n    else {\\n        goto(\\"/\\");\\n    }\\n}\\n// âœ… Por estas dos funciones\\nfunction hasMandatoryChecklistIncomplete() {\\n    const mandatory = (checklist || []).filter((i) => i.mandatory === \\"1\\");\\n    if (!mandatory.length)\\n        return false;\\n    return !mandatory.every((i) => !!i.img);\\n}\\nfunction needsChecklistOrKmGas() {\\n    var _a, _b;\\n    // km/gas pendientes (lo mismo que tu flag showChecklist)\\n    const kmGasMissing = showChecklist ||\\n        (stats === null || stats === void 0 ? void 0 : stats.km_inicial) === \\"0\\" ||\\n        (stats === null || stats === void 0 ? void 0 : stats.gas_inicial) === \\"0\\";\\n    // checklist obligatorio incompleto\\n    const mandatoryIncomplete = hasMandatoryChecklistIncomplete();\\n    const result = kmGasMissing || mandatoryIncomplete;\\n    console.log(\'ðŸ” needsChecklistOrKmGas:\', {\\n        showChecklist,\\n        km_inicial: stats === null || stats === void 0 ? void 0 : stats.km_inicial,\\n        gas_inicial: stats === null || stats === void 0 ? void 0 : stats.gas_inicial,\\n        kmGasMissing,\\n        mandatoryIncomplete,\\n        result,\\n        checklist: checklist === null || checklist === void 0 ? void 0 : checklist.length,\\n        mandatoryItems: (_a = checklist === null || checklist === void 0 ? void 0 : checklist.filter((i) => i.mandatory === \\"1\\")) === null || _a === void 0 ? void 0 : _a.length,\\n        completedMandatory: (_b = checklist === null || checklist === void 0 ? void 0 : checklist.filter((i) => i.mandatory === \\"1\\" && i.img)) === null || _b === void 0 ? void 0 : _b.length\\n    });\\n    return result;\\n}\\n// âž• NUEVO: true = puede editar, false = SOLO LECTURA\\nfunction canEditStops() {\\n    return !needsChecklistOrKmGas();\\n}\\n// ðŸ” Reemplaza COMPLETA la funciÃ³n maybeWarnChecklist por esta\\nfunction maybeWarnChecklist() {\\n    return __awaiter(this, void 0, void 0, function* () {\\n        console.log(\'ðŸ” maybeWarnChecklist called:\', {\\n            checklistWarnShown,\\n            needsChecklist: needsChecklistOrKmGas(),\\n            alertInProgress,\\n            showChecklist,\\n            km_inicial: stats === null || stats === void 0 ? void 0 : stats.km_inicial,\\n            gas_inicial: stats === null || stats === void 0 ? void 0 : stats.gas_inicial,\\n            checklist: checklist === null || checklist === void 0 ? void 0 : checklist.length\\n        });\\n        // Si ya no necesita checklist, permitir continuar\\n        if (!needsChecklistOrKmGas()) {\\n            console.log(\'âœ… Checklist completado, permitiendo continuar...\');\\n            return true;\\n        }\\n        // evitar mÃºltiples alerts\\n        if (alertInProgress) {\\n            console.log(\'â³ Alert en progreso, continuando...\');\\n            return true;\\n        }\\n        console.log(\'ðŸš¨ Mostrando advertencia del checklist...\');\\n        alertInProgress = true;\\n        return new Promise((resolve) => {\\n            alertController.create({\\n                header: \\"Checklist\\",\\n                message: \\"Favor de completar checklist para iniciar viaje âœ…\\",\\n                buttons: [\\n                    {\\n                        text: \\"Previsualizar\\",\\n                        handler: () => {\\n                            checklistWarnShown = true;\\n                            showStartButton = true;\\n                            alertInProgress = false;\\n                            resolve(true); // continuar\\n                        },\\n                    },\\n                    {\\n                        text: \\"Completar\\",\\n                        handler: () => {\\n                            checklistWarnShown = true;\\n                            alertInProgress = false;\\n                            showChecklistModal(checklist, driverId, routeId);\\n                            resolve(false); // NO continuar\\n                        },\\n                    },\\n                ],\\n            }).then(alert => {\\n                alert.present();\\n            }).catch(error => {\\n                console.error(\'Error en maybeWarnChecklist:\', error);\\n                alertInProgress = false;\\n                resolve(true); // continuar en caso de error\\n            });\\n        });\\n    });\\n}\\nfunction setSegmentValue(value) {\\n    return __awaiter(this, void 0, void 0, function* () {\\n        // advertencia (solo una vez) y aborta si eligen abrir el checklist\\n        const proceed = yield maybeWarnChecklist();\\n        if (!proceed)\\n            return;\\n        segmentValue = value;\\n        if (segmentValue === \\"map\\") {\\n            yield tick();\\n            mapElement = document.getElementById(\\"g_map\\");\\n            const map = new google.maps.Map(mapElement, {\\n                zoom: 8,\\n                center: { lat: 20.6745683, lng: -103.3986104 },\\n                mapId: \\"4504f8b37365c3d0\\",\\n            });\\n            const bounds = new google.maps.LatLngBounds();\\n            const { AdvancedMarkerElement, PinElement } = yield google.maps.importLibrary(\\"marker\\");\\n            // Get user\'s current location\\n            if (navigator.geolocation) {\\n                navigator.geolocation.getCurrentPosition(function (position) {\\n                    const userLatLng = new google.maps.LatLng(position.coords.latitude, position.coords.longitude);\\n                    // Add a blue dot to indicate the user\'s location\\n                    new google.maps.Marker({\\n                        position: userLatLng,\\n                        map: map,\\n                        icon: {\\n                            path: google.maps.SymbolPath.CIRCLE,\\n                            fillColor: \\"#0062ff\\",\\n                            fillOpacity: 1.0,\\n                            scale: 6, // Adjust size as needed\\n                            strokeColor: \\"#ffffff\\",\\n                            strokeWeight: 2,\\n                        },\\n                    });\\n                    // Optional: Draw an accuracy circle around the user\'s location\\n                    new google.maps.Circle({\\n                        strokeColor: \\"#00BFFF\\",\\n                        strokeOpacity: 0.5,\\n                        strokeWeight: 1,\\n                        fillColor: \\"#00BFFF\\",\\n                        fillOpacity: 0.2,\\n                        map: map,\\n                        center: userLatLng,\\n                        radius: position.coords.accuracy, // Radius is based on accuracy of location\\n                    });\\n                    // Extend the map bounds to include the user\'s location\\n                    bounds.extend(userLatLng);\\n                }, function (error) {\\n                    console.error(\\"Error retrieving location:\\", error);\\n                });\\n            }\\n            else {\\n                console.error(\\"Geolocation not supported by this browser.\\");\\n            }\\n            if (stats.lat1 === stats.lat2 && stats.lon1 === stats.lon2) {\\n                createMarker(bounds, map, {\\n                    lat: stats.lat2,\\n                    lon: stats.lon2,\\n                    color: stats.color,\\n                    title: stats.destination,\\n                }, {\\n                    type: \\"icon\\",\\n                    iconClass: \\"icon-home\\",\\n                    title: \\"Origen/Destino\\",\\n                    glyph: `0,${String(deliveries.length + 1)}`,\\n                });\\n            }\\n            else {\\n                //For origin marker\\n                createMarker(bounds, map, {\\n                    lat: stats.lat1,\\n                    lon: stats.lon1,\\n                    color: stats.color,\\n                    title: stats.origin,\\n                }, {\\n                    type: \\"icon\\",\\n                    iconClass: \\"icon-home\\",\\n                    title: \\"Origen\\",\\n                    glyph: \\"0\\",\\n                });\\n                //For destination marker\\n                createMarker(bounds, map, {\\n                    lat: stats.lat2,\\n                    lon: stats.lon2,\\n                    color: stats.color,\\n                    title: stats.destination,\\n                }, {\\n                    type: \\"icon\\",\\n                    iconClass: \\"icon-flag\\",\\n                    title: \\"Destino\\",\\n                    glyph: String(deliveries.length + 1),\\n                });\\n            }\\n            // Adding markers for stops/events\\n            deliveries.forEach((delivery) => {\\n                const lat = parseFloat(delivery.lat);\\n                const lon = parseFloat(delivery.lon);\\n                const waypointLatLng = new google.maps.LatLng(lat, lon);\\n                const marker = new google.maps.Marker({\\n                    position: { lat: lat, lng: lon },\\n                    map: map,\\n                    title: delivery.title,\\n                });\\n                // Change the background color.\\n                const pin = new PinElement({\\n                    background: getDeliveryColor(delivery.status, delivery.date_service),\\n                    borderColor: \\"#000\\",\\n                    glyphColor: \\"#000\\",\\n                    glyph: (parseInt(delivery.pos) + 1).toString(),\\n                });\\n                const waypointMarker = new AdvancedMarkerElement({\\n                    map: map,\\n                    position: waypointLatLng,\\n                    content: pin.element,\\n                    title: \\"Parada \\" +\\n                        (parseInt(delivery.pos) + 1).toString() +\\n                        \\": \\" +\\n                        delivery.title,\\n                });\\n                waypointMarker.addListener(\\"click\\", function () {\\n                    return __awaiter(this, void 0, void 0, function* () {\\n                        const proceed = yield maybeWarnChecklist();\\n                        if (proceed) {\\n                            showDeliveryInfoModal(delivery, false);\\n                        }\\n                    });\\n                });\\n                bounds.extend(marker.getPosition());\\n            });\\n            incidences.forEach((inc) => {\\n                const lat = +inc.lat, lng = +inc.lng;\\n                if (isNaN(lat) || isNaN(lng))\\n                    return;\\n                const iconName = motiveIconName[inc.type] || \\"alert-sharp\\";\\n                /* contenedor para el pin */\\n                const wrapper = document.createElement(\\"div\\");\\n                wrapper.style.cssText =\\n                    \\"display:flex;align-items:center;justify-content:center;\\" +\\n                        \\"transform:scale(.85);\\";\\n                const ion = document.createElement(\\"ion-icon\\");\\n                /* Ionicon integrado o svg externo */\\n                if (iconName.startsWith(\\"/\\")) {\\n                    ion.setAttribute(\\"src\\", iconName); // hospital.svg, toilet.svg\\n                }\\n                else {\\n                    ion.setAttribute(\\"icon\\", iconName); // warning-sharp, etc.\\n                }\\n                ion.style.cssText = \\"font-size:20px;color:#d13434;\\";\\n                wrapper.appendChild(ion);\\n                /* Pin rojo para incidencias */\\n                const pin = new PinElement({\\n                    background: \\"#fff\\",\\n                    borderColor: \\"#000\\",\\n                    glyph: wrapper,\\n                });\\n                const marker = new AdvancedMarkerElement({\\n                    map,\\n                    position: { lat, lng: lng },\\n                    content: pin.element,\\n                    title: inc.motive || inc.type,\\n                });\\n                bounds.extend(marker.position);\\n            });\\n            // Adjust map to fit all markers\\n            map.fitBounds(bounds);\\n        }\\n    });\\n}\\nfunction createMarker(bounds, map, obj, contentConfig) {\\n    return __awaiter(this, void 0, void 0, function* () {\\n        let contentElement;\\n        const lat = parseFloat(obj.lat);\\n        const lon = parseFloat(obj.lon);\\n        const waypointLatLng = new google.maps.LatLng(lat, lon);\\n        const { AdvancedMarkerElement, PinElement } = yield google.maps.importLibrary(\\"marker\\");\\n        if (contentConfig.type == \\"icon\\") {\\n            contentElement = document.createElement(\\"i\\");\\n            contentElement.className = `${contentConfig.iconClass} icon`; // Add your icon class\\n            contentElement.style.fontSize = \\"14px\\"; // Adjust size as needed\\n            contentElement.style.color = getContrast(obj.color); // Set color dynamically\\n            contentElement.style.fontWeight = \\"600\\";\\n        }\\n        else if (contentConfig.type == \\"text\\") {\\n            //En caso de querer markers con texto en el futuro\\n        }\\n        const marker = new google.maps.Marker({\\n            position: { lat: lat, lng: lon },\\n            map: map,\\n            title: `${contentConfig.title}. ${obj.title}`,\\n        });\\n        // Change the background color.\\n        const pin = new PinElement({\\n            background: obj.color,\\n            borderColor: \\"#000\\",\\n            glyphColor: getContrast(obj.color),\\n            glyph: contentConfig.glyph,\\n        });\\n        const waypointMarker = new AdvancedMarkerElement({\\n            map: map,\\n            position: waypointLatLng,\\n            content: pin.element,\\n            title: contentConfig.title + \\": \\" + obj.title,\\n        });\\n        waypointMarker.addListener(\\"click\\", function () {\\n            return __awaiter(this, void 0, void 0, function* () {\\n                const proceed = yield maybeWarnChecklist();\\n                if (proceed) {\\n                    showOrigenDestinyModal(stats, contentConfig.title == \\"Destino\\" ||\\n                        contentConfig.title == \\"Origen/Destino\\");\\n                }\\n            });\\n        });\\n        return marker;\\n    });\\n}\\nfunction loadRoute(routeId) {\\n    return __awaiter(this, void 0, void 0, function* () {\\n        let requestData = new FormData();\\n        requestData.append(\\"id_route\\", routeId);\\n        requestData = addAuthData(requestData);\\n        requestData.append(\\"id_enterprise\\", dataSession.id_enterprise);\\n        try {\\n            const response = yield fetch(`${back_url}api/admin/report/seguimiento_list.php`, {\\n                method: \\"POST\\",\\n                body: requestData,\\n            });\\n            const data = yield response.json();\\n            stats = data.data.seguimiento_list[0];\\n            deliveries = data.data.event_list;\\n            checklist = data.data.checklist;\\n            expenses = data.data.expenses;\\n            incidences = data.data.incidence_list;\\n            if (stats) {\\n                showChecklist =\\n                    stats.km_inicial == \\"0\\" && stats.gas_inicial == \\"0\\";\\n            }\\n            // NUEVO: Mostrar botÃ³n automÃ¡ticamente si hay checklist pendiente\\n            if (needsChecklistOrKmGas()) {\\n                showStartButton = true;\\n            }\\n            // No ocultar el botÃ³n despuÃ©s de completar el checklist - mantenerlo visible\\n            // Advertir si faltan km/gas o checklist obligatorio (solo una vez)\\n            if (!checklistWarnShown && needsChecklistOrKmGas() && hasMandatoryChecklistIncomplete()) {\\n                yield maybeWarnChecklist();\\n            }\\n            loading = false; // Data loading complete\\n        }\\n        catch (error) {\\n            loading = false; // Data loading complete\\n            console.error(\\"Error fetching data:\\", error);\\n        }\\n    });\\n}\\nfunction getDeliveryColor(status, service_time = \\"\\") {\\n    let color = \\"#ffffff\\";\\n    if (status === \\"pending\\" && !service_time) {\\n        color = \\"#f2e300\\";\\n    }\\n    else if (status == \\"pending\\" && service_time) {\\n        color = \\"#F6A833\\";\\n    }\\n    else if (status === \\"completed\\") {\\n        color = \\"#44d900\\";\\n    }\\n    return color;\\n}\\nfunction getStatusTitle(status) {\\n    let state = \\"\\";\\n    if (status == \\"pending\\") {\\n        state = \\"Pendiente\\";\\n    }\\n    else if (status == \\"completed\\") {\\n        state = \\"Completado\\";\\n    }\\n    return state;\\n}\\nfunction getContrast(hexColor) {\\n    if (!hexColor)\\n        return \\"#414040\\";\\n    if (hexColor.slice(0, 1) === \\"#\\") {\\n        hexColor = hexColor.slice(1);\\n    }\\n    if (hexColor.length === 3) {\\n        hexColor = hexColor\\n            .split(\\"\\")\\n            .map(function (hex) {\\n            return hex + hex;\\n        })\\n            .join(\\"\\");\\n    }\\n    const r = parseInt(hexColor.substr(0, 2), 16);\\n    const g = parseInt(hexColor.substr(2, 2), 16);\\n    const b = parseInt(hexColor.substr(4, 2), 16);\\n    const yiq = (r * 299 + g * 587 + b * 114) / 1000;\\n    return yiq >= 128 ? \\"#414040\\" : \\"#fff\\";\\n}\\nconst refresh_event_info = (delivery) => {\\n    return new Promise((resolve, reject) => {\\n        let requestData = new FormData();\\n        requestData.append(\\"id_route\\", delivery.id_route);\\n        requestData.append(\\"id_event\\", delivery.id_event);\\n        requestData = addAuthData(requestData);\\n        fetch(`${back_url}api/admin/evidence/evidence_by_event.php`, {\\n            method: \\"POST\\",\\n            body: requestData,\\n        })\\n            .then((response) => response.json())\\n            .then((data) => {\\n            resolve(data.data.event_evidence[0]);\\n        })\\n            .catch((error) => {\\n            console.error(\\"Error fetching data:\\", error);\\n            reject(error);\\n        });\\n    });\\n};\\nfunction showDeliveryInfoModal(delivery, isLast, readOnly) {\\n    // readOnly por default depende del estado del checklist/KM-Gas\\n    const isReadOnly = typeof readOnly === \\"boolean\\" ? readOnly : !canEditStops();\\n    if (deliveryInfoModalPromise)\\n        return deliveryInfoModalPromise;\\n    deliveryInfoModalPromise = (() => __awaiter(this, void 0, void 0, function* () {\\n        let evidenceData = null;\\n        try {\\n            evidenceData = yield refresh_event_info(delivery);\\n        }\\n        catch (_) { }\\n        const payload = Object.assign(Object.assign(Object.assign({}, delivery), { stopsApproval,\\n            smsActive,\\n            signatureActive }), (evidenceData || {}));\\n        try {\\n            yield IonicShowModal(\\"modal-delivery-info\\", DeliveryInfo, {\\n                delivery: payload,\\n                isLast,\\n                // ðŸ‘‡ PASA EL MODO LECTURA AL MODAL\\n                readOnly: isReadOnly,\\n                // ðŸ‘‡ PASA LA FUNCIÃ“N DE ADVERTENCIA\\n                maybeWarnChecklist,\\n            });\\n        }\\n        finally {\\n            deliveryInfoModalPromise = null;\\n            loadRoute(routeId);\\n        }\\n    }))();\\n    return deliveryInfoModalPromise;\\n}\\nconst showOrigenDestinyModal = (stats, isLast) => {\\n    let delivery = {};\\n    if (isLast) {\\n        delivery = {\\n            title: stats.destination,\\n            line1: stats.dest_address,\\n        };\\n    }\\n    else {\\n        delivery = {\\n            title: stats.origin,\\n            line1: stats.origin_address,\\n        };\\n    }\\n    delivery.enterprise_name = stats.enterprise_name;\\n    delivery.client_name = stats.client_name;\\n    delivery.client_phone = stats.tel;\\n    delivery.id_route = stats.id_route;\\n    delivery.stopsApproval = stopsApproval;\\n    delivery.smsActive = smsActive;\\n    const flag = true;\\n    IonicShowModal(\\"modal-delivery-info\\", DeliveryInfo, {\\n        delivery,\\n        isLast,\\n        flag,\\n        // ðŸ‘‡ Solo lectura si falta checklist obligatorio o KM/Gas inicial\\n        readOnly: !canEditStops(),\\n        // ðŸ‘‡ PASA LA FUNCIÃ“N DE ADVERTENCIA\\n        maybeWarnChecklist,\\n    });\\n};\\nconst showChecklistModal = (checklist, driverId, routeId) => {\\n    // NUEVO: Si ya se presionÃ³ el botÃ³n (routeStarted), no abrir el modal\\n    if (routeStarted) {\\n        return \\"\\";\\n    }\\n    const isLast = false;\\n    isLoading = true;\\n    if (!isModalOpen) {\\n        isModalOpen = true;\\n        IonicShowModal(\\"modal-checklist\\", ChecklistControl, { checklist, driverId, routeId, isLast }, {\\n            breakpoints: [0.25, 0.5, 0.9],\\n            initialBreakpoint: 0.75,\\n            backdropBreakpoint: 0.25,\\n            handle: true,\\n            handleBehavior: \\"cycle\\",\\n            canDismiss: true,\\n            showBackdrop: true\\n        }).then(() => __awaiter(void 0, void 0, void 0, function* () {\\n            isLoading = false;\\n            isModalOpen = false;\\n            routeStarted = true; // NUEVO: cambiar a verde despuÃ©s de presionar\\n            // al cerrar el modal, refrescamos por si se completÃ³ algo\\n            yield loadRoute(routeId);\\n            // Resetear la advertencia para que pueda aparecer de nuevo si es necesario\\n            checklistWarnShown = false;\\n            console.log(\'ðŸ”„ Modal cerrado, data refrescada, warnings reseteados\');\\n        }));\\n        // (opcional) changeRouteStatus(routeId, \\"checklist\\");\\n    }\\n    return \\"\\";\\n};\\nconst showExpenseModal = (routeId) => __awaiter(void 0, void 0, void 0, function* () {\\n    isLoading = true;\\n    yield loadRoute(routeId);\\n    if (expenses.length > 0) {\\n        IonicShowModal(\\"modal-expense-detail\\", ExpenseDetails, {\\n            routeId,\\n            expenses,\\n        }).then(() => {\\n            isLoading = false;\\n        });\\n    }\\n    else {\\n        IonicShowModal(\\"modal-expense\\", AddExpense, {\\n            routeId,\\n        }).then(() => {\\n            isLoading = false;\\n        });\\n    }\\n    return \\"\\";\\n});\\nconst showIncidenceModal = (routeId) => __awaiter(void 0, void 0, void 0, function* () {\\n    isLoading = true;\\n    yield loadRoute(routeId);\\n    IonicShowModal(\\"modal-incidence\\", AddIncidence, {\\n        routeId,\\n    }).then(() => {\\n        isLoading = false;\\n    });\\n    return \\"\\";\\n});\\nconst mustCharge = (delivery) => {\\n    if (delivery.tracking_type == \\"subscription\\") {\\n        if (delivery.subscriber_info && delivery.payment_type === \\"cash\\") {\\n            let date = new Date(delivery.subscriber_info.payment_next);\\n            if (date < new Date()) {\\n                return true;\\n            }\\n        }\\n    }\\n    else if (delivery.tracking_type == \\"ecommerce\\") {\\n        if (Number(delivery.payment_pending) > 0) {\\n            return true;\\n        }\\n    }\\n    return false;\\n};\\nfunction changeRouteStatus(id_route, status) {\\n    let requestData = new FormData();\\n    requestData.append(\\"id_route\\", id_route);\\n    requestData.append(\\"status\\", status);\\n    requestData = addAuthData(requestData);\\n    fetch(`${back_url}api/admin/route/change_status.php`, {\\n        method: \\"POST\\",\\n        body: requestData,\\n    })\\n        .then((response) => response.json())\\n        .then(() => { })\\n        .catch((error) => {\\n        console.error(\\"Error fetching data:\\", error);\\n    });\\n    return \\"\\";\\n}\\nconst goBack = () => {\\n    if (dataSession.type == \\"super\\" || dataSession.type == \\"admin\\") {\\n        goto(`/drivers/me`);\\n    }\\n    else if (dataSession.id_driver) {\\n        goto(`/drivers/${dataSession.id_driver}`);\\n    }\\n};\\nconst showAlert = (customHeader, customMessage) => __awaiter(void 0, void 0, void 0, function* () {\\n    const alert = yield alertController.create({\\n        header: customHeader || \\"Error\\",\\n        message: customMessage || \\"Vuelva a intentar\\",\\n        buttons: [{ text: \\"Cerrar\\" }],\\n    });\\n    yield alert.present();\\n});\\nfunction addAuthData(requestData) {\\n    requestData.append(\\"token\\", dataSession.token);\\n    requestData.append(\\"id_user_over\\", dataSession.id_user);\\n    return requestData;\\n}\\nconst checkSettings = () => __awaiter(void 0, void 0, void 0, function* () {\\n    if (dataSession.id_enterprise) {\\n        let formData = new FormData();\\n        formData.append(\\"id_enterprise\\", dataSession.id_enterprise);\\n        formData = addAuthData(formData);\\n        try {\\n            const response = yield fetch(`${back_url}api/admin/enterprise/enterprise_settings.php`, {\\n                method: \\"POST\\",\\n                body: formData,\\n            });\\n            if (response.ok) {\\n                const result = yield response.json();\\n                settings = result.nodos;\\n                stopsApproval = getSettingVal(\\"stops_wait_approval\\", settings);\\n                smsActive = getSettingVal(\\"sms_active\\", settings);\\n                orderRestriction = getSettingVal(\\"stops_order_restriction\\", settings);\\n                signatureActive = getSettingVal(\\"signature_active\\", settings);\\n            }\\n            else {\\n                console.error(\\"File upload failed:\\", response.statusText);\\n            }\\n        }\\n        catch (error) {\\n            console.error(\\"Error during file upload:\\", error);\\n        }\\n    }\\n});\\nfunction getSettingVal(alias, settings) {\\n    for (let i = 0; i < settings.length; i++) {\\n        if (settings[i].alias === alias) {\\n            return settings[i].val;\\n        }\\n    }\\n    return \\"\\";\\n}\\n<\/script>\\r\\n\\r\\n<svelte:head>\\r\\n    <title>Rutaflow - Detalles de ruta</title>\\r\\n</svelte:head>\\r\\n\\r\\n{#if dataSession}\\r\\n    <IonPage>\\r\\n        <ion-header translucent>\\r\\n            <ion-toolbar>\\r\\n                <ion-buttons slot=\\"start\\">\\r\\n                    <ion-button title=\\"AtrÃ¡s\\" alt=\\"AtrÃ¡s\\" on:click={goBack}\\r\\n                        ><ion-icon icon={arrowBack} /></ion-button\\r\\n                    >\\r\\n                </ion-buttons>\\r\\n                <ion-buttons slot=\\"end\\">\\r\\n                    <ion-button on:click={async () => {\\r\\n                        const proceed = await maybeWarnChecklist();\\r\\n                        if (proceed) {\\r\\n                            showIncidenceModal(routeId);\\r\\n                        }\\r\\n                    }}\\r\\n                        ><ion-icon icon={warningOutline} /></ion-button\\r\\n                    >\\r\\n                    <ion-button on:click={async () => {\\r\\n                        const proceed = await maybeWarnChecklist();\\r\\n                        if (proceed) {\\r\\n                            showExpenseModal(routeId);\\r\\n                        }\\r\\n                    }}\\r\\n                        ><ion-icon icon={cashOutline} /></ion-button\\r\\n                    >\\r\\n                </ion-buttons>\\r\\n\\r\\n                <ion-title\\r\\n                    >{stats.name ? stats.name.toUpperCase() : \\"\\"}</ion-title\\r\\n                >\\r\\n            </ion-toolbar>\\r\\n            <!-- Tabs for switching between List and Map -->\\r\\n            <ion-segment\\r\\n                value=\\"list\\"\\r\\n                on:ionChange={(e) => setSegmentValue(e.detail.value)}\\r\\n            >\\r\\n                <ion-segment-button value=\\"list\\">\\r\\n                    <ion-label>Paradas</ion-label>\\r\\n                </ion-segment-button>\\r\\n                <ion-segment-button value=\\"map\\">\\r\\n                    <ion-label>Mapa</ion-label>\\r\\n                </ion-segment-button>\\r\\n            </ion-segment>\\r\\n        </ion-header>\\r\\n        <!-- Conditional rendering based on the selected tab -->\\r\\n        {#if segmentValue === \\"list\\"}\\r\\n            {#if checklist.length > 0}\\r\\n                {#if checklist\\r\\n                    .filter((item) => item.mandatory === \\"1\\")\\r\\n                    .every((item) => item.img) && !showChecklist}\\r\\n                    <ion-content>\\r\\n                        <ion-refresher\\r\\n                            slot=\\"fixed\\"\\r\\n                            bind:this={refresher}\\r\\n                            on:ionRefresh={refresh}\\r\\n                        >\\r\\n                            <ion-refresher-content\\r\\n                                pulling-icon=\\"arrow-dropdown\\"\\r\\n                                pulling-text=\\"Jale para actualizar\\"\\r\\n                                refreshing-spinner=\\"circles\\"\\r\\n                                refreshing-text=\\"Actualizando...\\"\\r\\n                            />\\r\\n                        </ion-refresher>\\r\\n                        <ion-list>\\r\\n                            <ion-item>\\r\\n                                <ion-avatar slot=\\"start\\">\\r\\n                                    <div\\r\\n                                        class=\\"order-wrapper\\"\\r\\n                                        title=\\"${stats.origin}\\"\\r\\n                                        style=\\"background-color: {stats.color}; color: {getContrast(\\r\\n                                            stats.color\\r\\n                                        )}\\"\\r\\n                                    >\\r\\n                                        <div class=\\"order\\">0</div>\\r\\n                                    </div>\\r\\n                                </ion-avatar>\\r\\n                                <ion-label\\r\\n                                    button\\r\\n                                    on:click={async () => {\\r\\n                                        const proceed = await maybeWarnChecklist();\\r\\n                                        if (proceed) {\\r\\n                                            showOrigenDestinyModal(stats, false);\\r\\n                                        }\\r\\n                                    }}\\r\\n                                >\\r\\n                                    <ion-text color=\\"#2e2e2e\\">\\r\\n                                        <h3>\\r\\n                                            {stats.origin}\\r\\n                                        </h3>\\r\\n                                    </ion-text>\\r\\n                                    <div class=\\"sub\\" />\\r\\n                                </ion-label>\\r\\n                                <ion-icon icon={locationOutline} slot=\\"end\\" />\\r\\n                            </ion-item>\\r\\n                            {#each deliveries as delivery, index (delivery.id_event)}\\r\\n                                <ion-item>\\r\\n                                    <ion-avatar slot=\\"start\\">\\r\\n                                        <div\\r\\n                                            class=\\"order-wrapper\\"\\r\\n                                            title={getStatusTitle(\\r\\n                                                delivery.status\\r\\n                                            )}\\r\\n                                            style=\\"background-color: {getDeliveryColor(\\r\\n                                                delivery.status,\\r\\n                                                delivery.date_service\\r\\n                                            )}; color: {getContrast(\\r\\n                                                getDeliveryColor(\\r\\n                                                    delivery.status\\r\\n                                                )\\r\\n                                            )}\\"\\r\\n                                        >\\r\\n                                            <div class=\\"order\\">\\r\\n                                                {parseInt(delivery.pos) + 1}\\r\\n                                            </div>\\r\\n                                        </div>\\r\\n                                    </ion-avatar>\\r\\n                                    <ion-label\\r\\n                                        button\\r\\n                                        on:click={async () => {\\r\\n                                            const currentIndex =\\r\\n                                                deliveries.findIndex(\\r\\n                                                    (item) =>\\r\\n                                                        item.id_event ===\\r\\n                                                        delivery.id_event\\r\\n                                                );\\r\\n                                            const isFirstDelivery =\\r\\n                                                currentIndex === 0;\\r\\n                                            const previousDelivery =\\r\\n                                                currentIndex > 0\\r\\n                                                    ? deliveries[\\r\\n                                                          currentIndex - 1\\r\\n                                                      ]\\r\\n                                                    : null;\\r\\n                                            const previousDeliveryHasImage =\\r\\n                                                isFirstDelivery ||\\r\\n                                                (previousDelivery &&\\r\\n                                                    previousDelivery.img !==\\r\\n                                                        null);\\r\\n                                            const currentDeliveryHasImage =\\r\\n                                                delivery.img !== null &&\\r\\n                                                delivery.img !== \\"\\";\\r\\n\\r\\n                                            if (\\r\\n                                                previousDeliveryHasImage ||\\r\\n                                                (isFirstDelivery &&\\r\\n                                                    !currentDeliveryHasImage) ||\\r\\n                                                orderRestriction == \\"1\\"\\r\\n                                            ) {\\r\\n                                                const proceed = await maybeWarnChecklist();\\r\\n                                                if (proceed) {\\r\\n                                                    showDeliveryInfoModal(\\r\\n                                                        delivery,\\r\\n                                                        false\\r\\n                                                    );\\r\\n                                                }\\r\\n                                            } else {\\r\\n                                                showAlert(\\r\\n                                                    \\"InformaciÃ³n incompleta\\",\\r\\n                                                    \\"No puedes visualizar otras paradas hasta cargar evidencia del destino pasado\\"\\r\\n                                                );\\r\\n                                            }\\r\\n                                        }}\\r\\n                                    >\\r\\n                                        <ion-text color=\\"#2e2e2e\\">\\r\\n                                            <h3>\\r\\n                                                {delivery.title}\\r\\n                                                {#if (delivery.support_list && delivery.support_list.length) || mustCharge(delivery)}\\r\\n                                                    <span class=\\"notes\\" />\\r\\n                                                {/if}\\r\\n                                            </h3>\\r\\n                                        </ion-text>\\r\\n                                        <div class=\\"sub\\">\\r\\n                                        </div>\\r\\n                                    </ion-label>\\r\\n                                    {#if delivery.tag_color && delivery.tag}\\r\\n                                        <div\\r\\n                                            class=\\"stop-tag\\"\\r\\n                                            slot=\\"end\\"\\r\\n                                            style=\\"background-color:{hexToRGBA(\\r\\n                                                delivery.tag_color,\\r\\n                                                0.3\\r\\n                                            )};\\r\\n                                                border: 1px solid {hexToRGBA(\\r\\n                                                delivery.tag_color,\\r\\n                                                0.4\\r\\n                                            )}; \\r\\n                                                color: {delivery.tag_color};\\r\\n                                                font-size: 10px;\\r\\n                                                text-align: center;\\r\\n                                                align-content: center;\\r\\n                                                border-radius: 20px;\\r\\n                                                white-space: normal;\\r\\n                                                padding: 3px 6px;\\r\\n                                                width: auto !important;\\r\\n                                                display: inline-block;\\r\\n                                                font-weight: 500;\\"\\r\\n                                        >\\r\\n                                            {delivery.tag ? delivery.tag : \\"\\"}\\r\\n                                        </div>\\r\\n                                    {:else}\\r\\n                                        <ion-icon\\r\\n                                            icon={locationOutline}\\r\\n                                            slot=\\"end\\"\\r\\n                                            style=\\"color: {getDeliveryColor(\\r\\n                                                delivery.status,\\r\\n                                                delivery.date_service\\r\\n                                            )}\\"\\r\\n                                        />\\r\\n                                    {/if}\\r\\n                                </ion-item>\\r\\n                            {/each}\\r\\n                            <ion-item>\\r\\n                                <ion-avatar slot=\\"start\\">\\r\\n                                    <div\\r\\n                                        class=\\"order-wrapper\\"\\r\\n                                        title=\\"${stats.destination}\\"\\r\\n                                        style=\\"background-color: {stats.color}; color: {getContrast(\\r\\n                                            stats.color\\r\\n                                        )}\\"\\r\\n                                    >\\r\\n                                        <div class=\\"order\\">\\r\\n                                            {deliveries.length + 1}\\r\\n                                        </div>\\r\\n                                    </div>\\r\\n                                </ion-avatar>\\r\\n                                <ion-label\\r\\n                                    button\\r\\n                                    on:click={async () => {\\r\\n                                        const proceed = await maybeWarnChecklist();\\r\\n                                        if (proceed) {\\r\\n                                            showOrigenDestinyModal(stats, true);\\r\\n                                        }\\r\\n                                    }}\\r\\n                                >\\r\\n                                    <ion-text color=\\"#2e2e2e\\">\\r\\n                                        <h3>\\r\\n                                            {stats.destination}\\r\\n                                        </h3>\\r\\n                                    </ion-text>\\r\\n                                    <div class=\\"sub\\">\\r\\n                                    </div>\\r\\n                                </ion-label>\\r\\n                                <ion-icon icon={locationOutline} slot=\\"end\\" />\\r\\n                            </ion-item>\\r\\n                        </ion-list>\\r\\n                    </ion-content>\\r\\n                {:else}\\r\\n                    <!-- ANTES aquÃ­ abrÃ­a el modal automÃ¡ticamente.\\r\\n                         Se eliminÃ³ esa llamada para que solo advierta y el usuario decida. -->\\r\\n                    <ion-content>\\r\\n                        <ion-refresher\\r\\n                            slot=\\"fixed\\"\\r\\n                            bind:this={refresher}\\r\\n                            on:ionRefresh={refresh}\\r\\n                        >\\r\\n                            <ion-refresher-content\\r\\n                                pulling-icon=\\"arrow-dropdown\\"\\r\\n                                pulling-text=\\"Pull to refresh\\"\\r\\n                                refreshing-spinner=\\"circles\\"\\r\\n                                refreshing-text=\\"Refreshing...\\"\\r\\n                            />\\r\\n                        </ion-refresher>\\r\\n                        <ion-list>\\r\\n                            <ion-item>\\r\\n                                <ion-avatar slot=\\"start\\">\\r\\n                                    <div\\r\\n                                        class=\\"order-wrapper\\"\\r\\n                                        title=\\"${stats.origin}\\"\\r\\n                                        style=\\"background-color: {stats.color}; color: {getContrast(\\r\\n                                            stats.color\\r\\n                                        )}\\"\\r\\n                                    >\\r\\n                                        <div class=\\"order\\">0</div>\\r\\n                                    </div>\\r\\n                                </ion-avatar>\\r\\n                                <ion-label\\r\\n                                    button\\r\\n                                    on:click={async () => {\\r\\n                                        const proceed = await maybeWarnChecklist();\\r\\n                                        if (proceed) {\\r\\n                                            showOrigenDestinyModal(stats, false);\\r\\n                                        }\\r\\n                                    }}\\r\\n                                >\\r\\n                                    <ion-text color=\\"#2e2e2e\\">\\r\\n                                        <h3>\\r\\n                                            {stats.origin}\\r\\n                                        </h3>\\r\\n                                    </ion-text>\\r\\n                                    <div class=\\"sub\\" />\\r\\n                                </ion-label>\\r\\n                                <ion-icon icon={locationOutline} slot=\\"end\\" />\\r\\n                            </ion-item>\\r\\n                            {#each deliveries as delivery, index (delivery.id_event)}\\r\\n                                <ion-item>\\r\\n                                    <ion-avatar slot=\\"start\\">\\r\\n                                        <div\\r\\n                                            class=\\"order-wrapper\\"\\r\\n                                            title={getStatusTitle(\\r\\n                                                delivery.status\\r\\n                                            )}\\r\\n                                            style=\\"background-color: {getDeliveryColor(\\r\\n                                                delivery.status,\\r\\n                                                delivery.date_service\\r\\n                                            )}; color: {getContrast(\\r\\n                                                getDeliveryColor(\\r\\n                                                    delivery.status\\r\\n                                                )\\r\\n                                            )}\\"\\r\\n                                        >\\r\\n                                            <div class=\\"order\\">\\r\\n                                                {parseInt(delivery.pos) + 1}\\r\\n                                            </div>\\r\\n                                        </div>\\r\\n                                    </ion-avatar>\\r\\n                                    <ion-label\\r\\n                                        button\\r\\n                                        on:click={async () => {\\r\\n                                            const currentIndex =\\r\\n                                                deliveries.findIndex(\\r\\n                                                    (item) =>\\r\\n                                                        item.id_event ===\\r\\n                                                        delivery.id_event\\r\\n                                                );\\r\\n                                            const isFirstDelivery =\\r\\n                                                currentIndex === 0;\\r\\n                                            const previousDelivery =\\r\\n                                                currentIndex > 0\\r\\n                                                    ? deliveries[\\r\\n                                                          currentIndex - 1\\r\\n                                                      ]\\r\\n                                                    : null;\\r\\n                                            const previousDeliveryHasImage =\\r\\n                                                isFirstDelivery ||\\r\\n                                                (previousDelivery &&\\r\\n                                                    previousDelivery.img !==\\r\\n                                                        null);\\r\\n                                            const currentDeliveryHasImage =\\r\\n                                                delivery.img !== null &&\\r\\n                                                delivery.img !== \\"\\";\\r\\n\\r\\n                                            if (\\r\\n                                                previousDeliveryHasImage ||\\r\\n                                                (isFirstDelivery &&\\r\\n                                                    !currentDeliveryHasImage) ||\\r\\n                                                orderRestriction == \\"1\\"\\r\\n                                            ) {\\r\\n                                                const proceed = await maybeWarnChecklist();\\r\\n                                                if (proceed) {\\r\\n                                                    showDeliveryInfoModal(\\r\\n                                                        delivery,\\r\\n                                                        false\\r\\n                                                    );\\r\\n                                                }\\r\\n                                            } else {\\r\\n                                                showAlert(\\r\\n                                                    \\"InformaciÃ³n incompleta\\",\\r\\n                                                    \\"No puedes visualizar otras paradas hasta cargar evidencia del destino pasado\\"\\r\\n                                                );\\r\\n                                            }\\r\\n                                        }}\\r\\n                                    >\\r\\n                                        <ion-text color=\\"#2e2e2e\\">\\r\\n                                            <h3>\\r\\n                                                {delivery.title}\\r\\n                                                {#if (delivery.support_list && delivery.support_list.length) || mustCharge(delivery)}\\r\\n                                                    <span class=\\"notes\\" />\\r\\n                                                {/if}\\r\\n                                            </h3>\\r\\n                                        </ion-text>\\r\\n                                        <div class=\\"sub\\">\\r\\n                                        </div>\\r\\n                                    </ion-label>\\r\\n                                    {#if delivery.tag_color && delivery.tag}\\r\\n                                        <div\\r\\n                                            class=\\"stop-tag\\"\\r\\n                                            slot=\\"end\\"\\r\\n                                            style=\\"background-color:{hexToRGBA(\\r\\n                                                delivery.tag_color,\\r\\n                                                0.3\\r\\n                                            )};\\r\\n                                                border: 1px solid {hexToRGBA(\\r\\n                                                delivery.tag_color,\\r\\n                                                0.4\\r\\n                                            )}; \\r\\n                                                color: {delivery.tag_color};\\r\\n                                                font-size: 10px;\\r\\n                                                text-align: center;\\r\\n                                                align-content: center;\\r\\n                                                border-radius: 20px;\\r\\n                                                white-space: normal;\\r\\n                                                padding: 3px 6px;\\r\\n                                                width: auto !important;\\r\\n                                                display: inline-block;\\r\\n                                                font-weight: 500;\\"\\r\\n                                        >\\r\\n                                            {delivery.tag ? delivery.tag : \\"\\"}\\r\\n                                        </div>\\r\\n                                    {:else}\\r\\n                                        <ion-icon\\r\\n                                            icon={locationOutline}\\r\\n                                            slot=\\"end\\"\\r\\n                                            style=\\"color: {getDeliveryColor(\\r\\n                                                delivery.status,\\r\\n                                                delivery.date_service\\r\\n                                            )}\\"\\r\\n                                        />\\r\\n                                    {/if}\\r\\n                                </ion-item>\\r\\n                            {/each}\\r\\n                            <ion-item>\\r\\n                                <ion-avatar slot=\\"start\\">\\r\\n                                    <div\\r\\n                                        class=\\"order-wrapper\\"\\r\\n                                        title=\\"${stats.destination}\\"\\r\\n                                        style=\\"background-color: {stats.color}; color: {getContrast(\\r\\n                                            stats.color\\r\\n                                        )}\\"\\r\\n                                    >\\r\\n                                        <div class=\\"order\\">\\r\\n                                            {deliveries.length + 1}\\r\\n                                        </div>\\r\\n                                    </div>\\r\\n                                </ion-avatar>\\r\\n                                <ion-label\\r\\n                                    button\\r\\n                                    on:click={async () => {\\r\\n                                        const proceed = await maybeWarnChecklist();\\r\\n                                        if (proceed) {\\r\\n                                            showOrigenDestinyModal(stats, true);\\r\\n                                        }\\r\\n                                    }}\\r\\n                                >\\r\\n                                    <ion-text color=\\"#2e2e2e\\">\\r\\n                                        <h3>\\r\\n                                            {stats.destination}\\r\\n                                        </h3>\\r\\n                                    </ion-text>\\r\\n                                    <div class=\\"sub\\">\\r\\n                                    </div>\\r\\n                                </ion-label>\\r\\n                                <ion-icon icon={locationOutline} slot=\\"end\\" />\\r\\n                            </ion-item>\\r\\n                        </ion-list>\\r\\n                    </ion-content>\\r\\n                {/if}\\r\\n            {:else if !loading}\\r\\n                {#if showChecklist}\\r\\n                    <!-- Ya no abrimos modal automÃ¡ticamente -->\\r\\n                {/if}\\r\\n                <ion-content>\\r\\n                    <ion-refresher\\r\\n                        slot=\\"fixed\\"\\r\\n                        bind:this={refresher}\\r\\n                        on:ionRefresh={refresh}\\r\\n                    >\\r\\n                        <ion-refresher-content\\r\\n                            pulling-icon=\\"arrow-dropdown\\"\\r\\n                            pulling-text=\\"Jala para actualizar\\"\\r\\n                            refreshing-spinner=\\"circles\\"\\r\\n                            refreshing-text=\\"Actualizando...\\"\\r\\n                        />\\r\\n                    </ion-refresher>\\r\\n                    <ion-list>\\r\\n                        <ion-item>\\r\\n                            <ion-avatar slot=\\"start\\">\\r\\n                                <div\\r\\n                                    class=\\"order-wrapper\\"\\r\\n                                    title=\\"${stats.origin}\\"\\r\\n                                    style=\\"background-color: {stats.color}; color: {getContrast(\\r\\n                                        stats.color\\r\\n                                    )}\\"\\r\\n                                >\\r\\n                                    <div class=\\"order\\">0</div>\\r\\n                                </div>\\r\\n                            </ion-avatar>\\r\\n                            <ion-label\\r\\n                                button\\r\\n                                on:click={() => {\\r\\n                                    showOrigenDestinyModal(stats, false);\\r\\n                                }}\\r\\n                            >\\r\\n                                <ion-text color=\\"#2e2e2e\\">\\r\\n                                    <h3>\\r\\n                                        {stats.origin}\\r\\n                                    </h3>\\r\\n                                </ion-text>\\r\\n                                <div class=\\"sub\\" />\\r\\n                            </ion-label>\\r\\n                            <ion-icon icon={locationOutline} slot=\\"end\\" />\\r\\n                        </ion-item>\\r\\n                        {#each deliveries as delivery, index (delivery.id_event)}\\r\\n                            <ion-item>\\r\\n                                <ion-avatar slot=\\"start\\">\\r\\n                                    <div\\r\\n                                        class=\\"order-wrapper\\"\\r\\n                                        title={getStatusTitle(delivery.status)}\\r\\n                                        style=\\"background-color: {getDeliveryColor(\\r\\n                                            delivery.status,\\r\\n                                            delivery.date_service\\r\\n                                        )}; color: {getContrast(\\r\\n                                            getDeliveryColor(delivery.status)\\r\\n                                        )}\\"\\r\\n                                    >\\r\\n                                        <div class=\\"order\\">\\r\\n                                            {parseInt(delivery.pos) + 1}\\r\\n                                        </div>\\r\\n                                    </div>\\r\\n                                </ion-avatar>\\r\\n                                <ion-label\\r\\n                                    button\\r\\n                                    on:click={async () => {\\r\\n                                        const currentIndex =\\r\\n                                            deliveries.findIndex(\\r\\n                                                (item) =>\\r\\n                                                    item.id_event ===\\r\\n                                                    delivery.id_event\\r\\n                                            );\\r\\n                                        const isFirstDelivery =\\r\\n                                            currentIndex === 0;\\r\\n                                        const previousDelivery =\\r\\n                                            currentIndex > 0\\r\\n                                                ? deliveries[currentIndex - 1]\\r\\n                                                : null;\\r\\n                                        const previousDeliveryHasImage =\\r\\n                                            isFirstDelivery ||\\r\\n                                            (previousDelivery &&\\r\\n                                                previousDelivery.img !== null);\\r\\n                                        const currentDeliveryHasImage =\\r\\n                                            delivery.img !== null &&\\r\\n                                            delivery.img !== \\"\\";\\r\\n\\r\\n                                        if (\\r\\n                                            previousDeliveryHasImage ||\\r\\n                                            (isFirstDelivery &&\\r\\n                                                !currentDeliveryHasImage) ||\\r\\n                                            orderRestriction == \\"1\\"\\r\\n                                        ) {\\r\\n                                            showDeliveryInfoModal(\\r\\n                                                delivery,\\r\\n                                                false\\r\\n                                            );\\r\\n                                        } else {\\r\\n                                            showAlert(\\r\\n                                                \\"InformaciÃ³n incompleta\\",\\r\\n                                                \\"No puedes visualizar otras paradas hasta cargar evidencia del destino pasado\\"\\r\\n                                            );\\r\\n                                        }\\r\\n                                    }}\\r\\n                                >\\r\\n                                    <ion-text color=\\"#2e2e2e\\">\\r\\n                                        <h3>\\r\\n                                            {delivery.title}\\r\\n                                            {#if (delivery.support_list && delivery.support_list.length) || mustCharge(delivery)}\\r\\n                                                <span class=\\"notes\\" />\\r\\n                                            {/if}\\r\\n                                        </h3>\\r\\n                                    </ion-text>\\r\\n                                </ion-label>\\r\\n                                {#if delivery.tag_color && delivery.tag}\\r\\n                                    <div\\r\\n                                        class=\\"stop-tag\\"\\r\\n                                        slot=\\"end\\"\\r\\n                                        style=\\"background-color:{hexToRGBA(\\r\\n                                            delivery.tag_color,\\r\\n                                            0.3\\r\\n                                        )};\\r\\n                                                border: 1px solid {hexToRGBA(\\r\\n                                            delivery.tag_color,\\r\\n                                            0.4\\r\\n                                        )}; \\r\\n                                                color: {delivery.tag_color};\\r\\n                                                font-size: 10px;\\r\\n                                                text-align: center;\\r\\n                                                align-content: center;\\r\\n                                                border-radius: 20px;\\r\\n                                                white-space: normal;\\r\\n                                                padding: 3px 6px;\\r\\n                                                width: auto !important;\\r\\n                                                display: inline-block;\\r\\n                                                font-weight: 500;\\"\\r\\n                                    >\\r\\n                                        {delivery.tag ? delivery.tag : \\"\\"}\\r\\n                                    </div>\\r\\n                                {:else}\\r\\n                                    <ion-icon\\r\\n                                        icon={locationOutline}\\r\\n                                        slot=\\"end\\"\\r\\n                                        style=\\"color: {getDeliveryColor(\\r\\n                                            delivery.status,\\r\\n                                            delivery.date_service\\r\\n                                        )}\\"\\r\\n                                    />\\r\\n                                {/if}\\r\\n                            </ion-item>\\r\\n                        {/each}\\r\\n                        <ion-item>\\r\\n                            <ion-avatar slot=\\"start\\">\\r\\n                                <div\\r\\n                                    class=\\"order-wrapper\\"\\r\\n                                    title=\\"${stats.destination}\\"\\r\\n                                    style=\\"background-color: {stats.color}; color: {getContrast(\\r\\n                                        stats.color\\r\\n                                    )}\\"\\r\\n                                >\\r\\n                                    <div class=\\"order\\">\\r\\n                                        {deliveries.length + 1}\\r\\n                                    </div>\\r\\n                                </div>\\r\\n                            </ion-avatar>\\r\\n                            <ion-label\\r\\n                                button\\r\\n                                on:click={() => {\\r\\n                                    showOrigenDestinyModal(stats, true);\\r\\n                                }}\\r\\n                            >\\r\\n                                <ion-text color=\\"#2e2e2e\\">\\r\\n                                    <h3>\\r\\n                                        {stats.destination}\\r\\n                                    </h3>\\r\\n                                </ion-text>\\r\\n                                <div class=\\"sub\\">\\r\\n                                </div>\\r\\n                            </ion-label>\\r\\n                            <ion-icon icon={locationOutline} slot=\\"end\\" />\\r\\n                        </ion-item>\\r\\n                    </ion-list>\\r\\n                </ion-content>\\r\\n            {/if}\\r\\n\\r\\n        {#if segmentValue === \\"list\\" && showStartButton && needsChecklistOrKmGas()}\\r\\n              <ion-footer>\\r\\n                <ion-toolbar>\\r\\n                  <ion-button\\r\\n                    expand=\\"block\\"\\r\\n                    size=\\"large\\"\\r\\n                    color={routeStarted ? \\"success\\" : \\"primary\\"}\\r\\n                    on:click={() => showChecklistModal(checklist, driverId, routeId)}\\r\\n                    style=\\"margin: 8px;\\"\\r\\n                  >\\r\\n                    {routeStarted ? \\"Ruta iniciada âœ“\\" : \\"Iniciar ruta\\"}\\r\\n                  </ion-button>\\r\\n                </ion-toolbar>\\r\\n              </ion-footer>\\r\\n            {/if}\\r\\n\\r\\n        {:else if segmentValue === \\"map\\"}\\r\\n            <!-- Google Maps View -->\\r\\n            <ion-content>\\r\\n                <!-- HTML where the map will render -->\\r\\n                <div id=\\"g_map\\" style=\\"width: 100%; height: 100vh;\\" />\\r\\n            </ion-content>\\r\\n        {/if}\\r\\n    </IonPage>\\r\\n{/if}\\r\\n{#if isLoading}\\r\\n    <div\\r\\n        class=\\"overlay\\"\\r\\n        style=\\"position: fixed;\\r\\n                                top: 0;\\r\\n                                left: 0;\\r\\n                                width: 100vw;\\r\\n                                height: 100vh;\\r\\n                                background: rgba(0, 0, 0, 0.5);\\r\\n                                display: flex;\\r\\n                                align-items: center;\\r\\n                                justify-content: center;\\r\\n                                z-index: 9999;\\"\\r\\n    >\\r\\n        <ion-spinner name=\\"dots\\" style=\\"color:white;\\" />\\r\\n    </div>\\r\\n{/if}\\r\\n\\r\\n<style>\\r\\n    .sub {\\r\\n        font-size: 12px;\\r\\n        margin-top: 5px;\\r\\n    }\\r\\n\\r\\n    .order-wrapper {\\r\\n        width: 100%;\\r\\n        height: 100%;\\r\\n        border-radius: 50%;\\r\\n        border: 1px solid #cbcfde;\\r\\n        text-align: center;\\r\\n        display: flex;\\r\\n        justify-content: center;\\r\\n    }\\r\\n\\r\\n    .order {\\r\\n        align-self: center;\\r\\n    }\\r\\n\\r\\n    .notes {\\r\\n        background-color: #e0b500;\\r\\n        display: inline-block;\\r\\n        width: 8px;\\r\\n        height: 8px;\\r\\n        border-radius: 50%;\\r\\n    }\\r\\n    #map {\\r\\n        height: 400px;\\r\\n        width: 100%;\\r\\n    }\\r\\n</style>"],"names":[],"mappings":"AA+2CI,mBAAK,CACD,SAAS,CAAE,IAAI,CACf,UAAU,CAAE,GAChB,CAEA,6BAAe,CACX,KAAK,CAAE,IAAI,CACX,MAAM,CAAE,IAAI,CACZ,aAAa,CAAE,GAAG,CAClB,MAAM,CAAE,GAAG,CAAC,KAAK,CAAC,OAAO,CACzB,UAAU,CAAE,MAAM,CAClB,OAAO,CAAE,IAAI,CACb,eAAe,CAAE,MACrB,CAEA,qBAAO,CACH,UAAU,CAAE,MAChB,CAEA,qBAAO,CACH,gBAAgB,CAAE,OAAO,CACzB,OAAO,CAAE,YAAY,CACrB,KAAK,CAAE,GAAG,CACV,MAAM,CAAE,GAAG,CACX,aAAa,CAAE,GACnB"}'
};
function getDeliveryColor(status, service_time = "") {
  let color = "#ffffff";
  if (status === "pending" && !service_time) {
    color = "#f2e300";
  } else if (status == "pending" && service_time) {
    color = "#F6A833";
  } else if (status === "completed") {
    color = "#44d900";
  }
  return color;
}
function getStatusTitle(status) {
  let state = "";
  if (status == "pending") {
    state = "Pendiente";
  } else if (status == "completed") {
    state = "Completado";
  }
  return state;
}
function getContrast(hexColor) {
  if (!hexColor) return "#414040";
  if (hexColor.slice(0, 1) === "#") {
    hexColor = hexColor.slice(1);
  }
  if (hexColor.length === 3) {
    hexColor = hexColor.split("").map(function(hex) {
      return hex + hex;
    }).join("");
  }
  const r = parseInt(hexColor.substr(0, 2), 16);
  const g = parseInt(hexColor.substr(2, 2), 16);
  const b = parseInt(hexColor.substr(4, 2), 16);
  const yiq = (r * 299 + g * 587 + b * 114) / 1e3;
  return yiq >= 128 ? "#414040" : "#fff";
}
const Page = create_ssr_component(($$result, $$props, $$bindings, slots) => {
  let $page, $$unsubscribe_page;
  $$unsubscribe_page = subscribe(page, (value) => $page = value);
  var __awaiter = function(thisArg, _arguments, P, generator) {
    function adopt(value) {
      return value instanceof P ? value : new P(function(resolve) {
        resolve(value);
      });
    }
    return new (P || (P = Promise))(function(resolve, reject) {
      function fulfilled(value) {
        try {
          step(generator.next(value));
        } catch (e) {
          reject(e);
        }
      }
      function rejected(value) {
        try {
          step(generator["throw"](value));
        } catch (e) {
          reject(e);
        }
      }
      function step(result) {
        result.done ? resolve(result.value) : adopt(result.value).then(fulfilled, rejected);
      }
      step((generator = generator.apply(thisArg, [])).next());
    });
  };
  let { routeId } = $$props;
  let { driverId } = $$props;
  let back_url = DATABASE_URL;
  let dataSession = new Object();
  let loading = true;
  let showChecklist = false;
  let deliveries = [];
  let incidences = [];
  let stats = {};
  let checklist = [];
  let expenses = [];
  let refresher;
  let isModalOpen = false;
  let isLoading = false;
  let showStartButton = false;
  let routeStarted = false;
  let checklistWarnShown = false;
  let alertInProgress = false;
  function hasMandatoryChecklistIncomplete() {
    const mandatory = (checklist || []).filter((i) => i.mandatory === "1");
    if (!mandatory.length) return false;
    return !mandatory.every((i) => !!i.img);
  }
  function needsChecklistOrKmGas() {
    var _a, _b;
    const kmGasMissing = showChecklist || (stats === null || stats === void 0 ? void 0 : stats.km_inicial) === "0" || (stats === null || stats === void 0 ? void 0 : stats.gas_inicial) === "0";
    const mandatoryIncomplete = hasMandatoryChecklistIncomplete();
    const result = kmGasMissing || mandatoryIncomplete;
    console.log("ðŸ” needsChecklistOrKmGas:", {
      showChecklist,
      km_inicial: stats === null || stats === void 0 ? void 0 : stats.km_inicial,
      gas_inicial: stats === null || stats === void 0 ? void 0 : stats.gas_inicial,
      kmGasMissing,
      mandatoryIncomplete,
      result,
      checklist: checklist === null || checklist === void 0 ? void 0 : checklist.length,
      mandatoryItems: (_a = checklist === null || checklist === void 0 ? void 0 : checklist.filter((i) => i.mandatory === "1")) === null || _a === void 0 ? void 0 : _a.length,
      completedMandatory: (_b = checklist === null || checklist === void 0 ? void 0 : checklist.filter((i) => i.mandatory === "1" && i.img)) === null || _b === void 0 ? void 0 : _b.length
    });
    return result;
  }
  function maybeWarnChecklist() {
    return __awaiter(this, void 0, void 0, function* () {
      console.log("ðŸ” maybeWarnChecklist called:", {
        checklistWarnShown,
        needsChecklist: needsChecklistOrKmGas(),
        alertInProgress,
        showChecklist,
        km_inicial: stats === null || stats === void 0 ? void 0 : stats.km_inicial,
        gas_inicial: stats === null || stats === void 0 ? void 0 : stats.gas_inicial,
        checklist: checklist === null || checklist === void 0 ? void 0 : checklist.length
      });
      if (!needsChecklistOrKmGas()) {
        console.log("âœ… Checklist completado, permitiendo continuar...");
        return true;
      }
      if (alertInProgress) {
        console.log("â³ Alert en progreso, continuando...");
        return true;
      }
      console.log("ðŸš¨ Mostrando advertencia del checklist...");
      alertInProgress = true;
      return new Promise((resolve) => {
        alertController.create({
          header: "Checklist",
          message: "Favor de completar checklist para iniciar viaje âœ…",
          buttons: [
            {
              text: "Previsualizar",
              handler: () => {
                checklistWarnShown = true;
                showStartButton = true;
                alertInProgress = false;
                resolve(true);
              }
            },
            {
              text: "Completar",
              handler: () => {
                checklistWarnShown = true;
                alertInProgress = false;
                showChecklistModal(checklist, driverId, routeId);
                resolve(false);
              }
            }
          ]
        }).then((alert) => {
          alert.present();
        }).catch((error) => {
          console.error("Error en maybeWarnChecklist:", error);
          alertInProgress = false;
          resolve(true);
        });
      });
    });
  }
  function loadRoute(routeId2) {
    return __awaiter(this, void 0, void 0, function* () {
      let requestData = new FormData();
      requestData.append("id_route", routeId2);
      requestData = addAuthData(requestData);
      requestData.append("id_enterprise", dataSession.id_enterprise);
      try {
        const response = yield fetch(`${back_url}api/admin/report/seguimiento_list.php`, { method: "POST", body: requestData });
        const data = yield response.json();
        stats = data.data.seguimiento_list[0];
        deliveries = data.data.event_list;
        checklist = data.data.checklist;
        expenses = data.data.expenses;
        incidences = data.data.incidence_list;
        if (stats) {
          showChecklist = stats.km_inicial == "0" && stats.gas_inicial == "0";
        }
        if (needsChecklistOrKmGas()) {
          showStartButton = true;
        }
        if (!checklistWarnShown && needsChecklistOrKmGas() && hasMandatoryChecklistIncomplete()) {
          yield maybeWarnChecklist();
        }
        loading = false;
      } catch (error) {
        loading = false;
        console.error("Error fetching data:", error);
      }
    });
  }
  const showChecklistModal = (checklist2, driverId2, routeId2) => {
    if (routeStarted) {
      return "";
    }
    const isLast = false;
    isLoading = true;
    if (!isModalOpen) {
      isModalOpen = true;
      IonicShowModal("modal-checklist", ChecklistControl, { checklist: checklist2, driverId: driverId2, routeId: routeId2, isLast }, {
        breakpoints: [0.25, 0.5, 0.9],
        initialBreakpoint: 0.75,
        backdropBreakpoint: 0.25,
        handle: true,
        handleBehavior: "cycle",
        canDismiss: true,
        showBackdrop: true
      }).then(() => __awaiter(void 0, void 0, void 0, function* () {
        isLoading = false;
        isModalOpen = false;
        routeStarted = true;
        yield loadRoute(routeId2);
        checklistWarnShown = false;
        console.log("ðŸ”„ Modal cerrado, data refrescada, warnings reseteados");
      }));
    }
    return "";
  };
  const mustCharge = (delivery) => {
    if (delivery.tracking_type == "subscription") {
      if (delivery.subscriber_info && delivery.payment_type === "cash") {
        let date = new Date(delivery.subscriber_info.payment_next);
        if (date < /* @__PURE__ */ new Date()) {
          return true;
        }
      }
    } else if (delivery.tracking_type == "ecommerce") {
      if (Number(delivery.payment_pending) > 0) {
        return true;
      }
    }
    return false;
  };
  function addAuthData(requestData) {
    requestData.append("token", dataSession.token);
    requestData.append("id_user_over", dataSession.id_user);
    return requestData;
  }
  if ($$props.routeId === void 0 && $$bindings.routeId && routeId !== void 0) $$bindings.routeId(routeId);
  if ($$props.driverId === void 0 && $$bindings.driverId && driverId !== void 0) $$bindings.driverId(driverId);
  $$result.css.add(css);
  {
    {
      ({ routeId, driverId } = $page.params);
      checklistWarnShown = false;
      dataSession = JSON.parse(localStorage.getItem("userSession"));
      if (dataSession) {
        if (dataSession.id_user && (dataSession.type == "admin" || dataSession.type == "super")) {
          loadRoute(routeId);
          goto();
        } else if (dataSession.id_user && dataSession.id_driver) {
          loadRoute(routeId);
          goto(`/drivers/${dataSession.id_driver}/routes/${routeId}`);
        }
      } else {
        goto();
      }
    }
  }
  $$unsubscribe_page();
  return `${$$result.head += `<!-- HEAD_svelte-kn0kph_START -->${$$result.title = `<title>Rutaflow - Detalles de ruta</title>`, ""}<!-- HEAD_svelte-kn0kph_END -->`, ""} ${dataSession ? `${validate_component(IonPage, "IonPage").$$render($$result, {}, {}, {
    default: () => {
      return `<ion-header translucent><ion-toolbar><ion-buttons slot="start"><ion-button title="AtrÃ¡s" alt="AtrÃ¡s" data-svelte-h="svelte-1a21unf"><ion-icon${add_attribute("icon", arrowBack, 0)}></ion-icon></ion-button></ion-buttons> <ion-buttons slot="end"><ion-button data-svelte-h="svelte-b5yj9f"><ion-icon${add_attribute("icon", warningOutline, 0)}></ion-icon></ion-button> <ion-button data-svelte-h="svelte-11mnzbg"><ion-icon${add_attribute("icon", cashOutline, 0)}></ion-icon></ion-button></ion-buttons> <ion-title>${escape(stats.name ? stats.name.toUpperCase() : "")}</ion-title></ion-toolbar>  <ion-segment value="list" data-svelte-h="svelte-1rseadq"><ion-segment-button value="list"><ion-label>Paradas</ion-label></ion-segment-button> <ion-segment-button value="map"><ion-label>Mapa</ion-label></ion-segment-button></ion-segment></ion-header>  ${`${checklist.length > 0 ? `${checklist.filter((item) => item.mandatory === "1").every((item) => item.img) && !showChecklist ? `<ion-content><ion-refresher slot="fixed"${add_attribute("this", refresher, 0)} data-svelte-h="svelte-vjbhg4"><ion-refresher-content pulling-icon="arrow-dropdown" pulling-text="Jale para actualizar" refreshing-spinner="circles" refreshing-text="Actualizando..."></ion-refresher-content></ion-refresher> <ion-list><ion-item><ion-avatar slot="start"><div class="order-wrapper svelte-1ita8l7" title="${"$" + escape(stats.origin, true)}" style="${"background-color: " + escape(stats.color, true) + "; color: " + escape(getContrast(stats.color), true)}"><div class="order svelte-1ita8l7" data-svelte-h="svelte-b78non">0</div></div></ion-avatar> <ion-label button><ion-text color="#2e2e2e"><h3>${escape(stats.origin)}</h3></ion-text> <div class="sub svelte-1ita8l7"></div></ion-label> <ion-icon${add_attribute("icon", locationOutline, 0)} slot="end"></ion-icon></ion-item> ${each(deliveries, (delivery, index) => {
        return `<ion-item><ion-avatar slot="start"><div class="order-wrapper svelte-1ita8l7"${add_attribute("title", getStatusTitle(delivery.status), 0)} style="${"background-color: " + escape(getDeliveryColor(delivery.status, delivery.date_service), true) + "; color: " + escape(getContrast(getDeliveryColor(delivery.status)), true)}"><div class="order svelte-1ita8l7">${escape(parseInt(delivery.pos) + 1)}</div> </div></ion-avatar> <ion-label button><ion-text color="#2e2e2e"><h3>${escape(delivery.title)} ${delivery.support_list && delivery.support_list.length || mustCharge(delivery) ? `<span class="notes svelte-1ita8l7"></span>` : ``} </h3></ion-text> <div class="sub svelte-1ita8l7" data-svelte-h="svelte-4k5p1b"></div></ion-label> ${delivery.tag_color && delivery.tag ? `<div class="stop-tag" slot="end" style="${"background-color:" + escape(hexToRGBA(delivery.tag_color, 0.3), true) + "; border: 1px solid " + escape(hexToRGBA(delivery.tag_color, 0.4), true) + "; color: " + escape(delivery.tag_color, true) + "; font-size: 10px; text-align: center; align-content: center; border-radius: 20px; white-space: normal; padding: 3px 6px; width: auto !important; display: inline-block; font-weight: 500;"}">${escape(delivery.tag ? delivery.tag : "")} </div>` : `<ion-icon${add_attribute("icon", locationOutline, 0)} slot="end" style="${"color: " + escape(getDeliveryColor(delivery.status, delivery.date_service), true)}"></ion-icon>`} </ion-item>`;
      })} <ion-item><ion-avatar slot="start"><div class="order-wrapper svelte-1ita8l7" title="${"$" + escape(stats.destination, true)}" style="${"background-color: " + escape(stats.color, true) + "; color: " + escape(getContrast(stats.color), true)}"><div class="order svelte-1ita8l7">${escape(deliveries.length + 1)}</div></div></ion-avatar> <ion-label button><ion-text color="#2e2e2e"><h3>${escape(stats.destination)}</h3></ion-text> <div class="sub svelte-1ita8l7" data-svelte-h="svelte-1uxrbi7"></div></ion-label> <ion-icon${add_attribute("icon", locationOutline, 0)} slot="end"></ion-icon></ion-item></ion-list></ion-content>` : ` <ion-content><ion-refresher slot="fixed"${add_attribute("this", refresher, 0)} data-svelte-h="svelte-1l8nqqz"><ion-refresher-content pulling-icon="arrow-dropdown" pulling-text="Pull to refresh" refreshing-spinner="circles" refreshing-text="Refreshing..."></ion-refresher-content></ion-refresher> <ion-list><ion-item><ion-avatar slot="start"><div class="order-wrapper svelte-1ita8l7" title="${"$" + escape(stats.origin, true)}" style="${"background-color: " + escape(stats.color, true) + "; color: " + escape(getContrast(stats.color), true)}"><div class="order svelte-1ita8l7" data-svelte-h="svelte-b78non">0</div></div></ion-avatar> <ion-label button><ion-text color="#2e2e2e"><h3>${escape(stats.origin)}</h3></ion-text> <div class="sub svelte-1ita8l7"></div></ion-label> <ion-icon${add_attribute("icon", locationOutline, 0)} slot="end"></ion-icon></ion-item> ${each(deliveries, (delivery, index) => {
        return `<ion-item><ion-avatar slot="start"><div class="order-wrapper svelte-1ita8l7"${add_attribute("title", getStatusTitle(delivery.status), 0)} style="${"background-color: " + escape(getDeliveryColor(delivery.status, delivery.date_service), true) + "; color: " + escape(getContrast(getDeliveryColor(delivery.status)), true)}"><div class="order svelte-1ita8l7">${escape(parseInt(delivery.pos) + 1)}</div> </div></ion-avatar> <ion-label button><ion-text color="#2e2e2e"><h3>${escape(delivery.title)} ${delivery.support_list && delivery.support_list.length || mustCharge(delivery) ? `<span class="notes svelte-1ita8l7"></span>` : ``} </h3></ion-text> <div class="sub svelte-1ita8l7" data-svelte-h="svelte-4k5p1b"></div></ion-label> ${delivery.tag_color && delivery.tag ? `<div class="stop-tag" slot="end" style="${"background-color:" + escape(hexToRGBA(delivery.tag_color, 0.3), true) + "; border: 1px solid " + escape(hexToRGBA(delivery.tag_color, 0.4), true) + "; color: " + escape(delivery.tag_color, true) + "; font-size: 10px; text-align: center; align-content: center; border-radius: 20px; white-space: normal; padding: 3px 6px; width: auto !important; display: inline-block; font-weight: 500;"}">${escape(delivery.tag ? delivery.tag : "")} </div>` : `<ion-icon${add_attribute("icon", locationOutline, 0)} slot="end" style="${"color: " + escape(getDeliveryColor(delivery.status, delivery.date_service), true)}"></ion-icon>`} </ion-item>`;
      })} <ion-item><ion-avatar slot="start"><div class="order-wrapper svelte-1ita8l7" title="${"$" + escape(stats.destination, true)}" style="${"background-color: " + escape(stats.color, true) + "; color: " + escape(getContrast(stats.color), true)}"><div class="order svelte-1ita8l7">${escape(deliveries.length + 1)}</div></div></ion-avatar> <ion-label button><ion-text color="#2e2e2e"><h3>${escape(stats.destination)}</h3></ion-text> <div class="sub svelte-1ita8l7" data-svelte-h="svelte-1uxrbi7"></div></ion-label> <ion-icon${add_attribute("icon", locationOutline, 0)} slot="end"></ion-icon></ion-item></ion-list></ion-content>`}` : `${!loading ? `${showChecklist ? `` : ``} <ion-content><ion-refresher slot="fixed"${add_attribute("this", refresher, 0)} data-svelte-h="svelte-1mlmyg"><ion-refresher-content pulling-icon="arrow-dropdown" pulling-text="Jala para actualizar" refreshing-spinner="circles" refreshing-text="Actualizando..."></ion-refresher-content></ion-refresher> <ion-list><ion-item><ion-avatar slot="start"><div class="order-wrapper svelte-1ita8l7" title="${"$" + escape(stats.origin, true)}" style="${"background-color: " + escape(stats.color, true) + "; color: " + escape(getContrast(stats.color), true)}"><div class="order svelte-1ita8l7" data-svelte-h="svelte-b78non">0</div></div></ion-avatar> <ion-label button><ion-text color="#2e2e2e"><h3>${escape(stats.origin)}</h3></ion-text> <div class="sub svelte-1ita8l7"></div></ion-label> <ion-icon${add_attribute("icon", locationOutline, 0)} slot="end"></ion-icon></ion-item> ${each(deliveries, (delivery, index) => {
        return `<ion-item><ion-avatar slot="start"><div class="order-wrapper svelte-1ita8l7"${add_attribute("title", getStatusTitle(delivery.status), 0)} style="${"background-color: " + escape(getDeliveryColor(delivery.status, delivery.date_service), true) + "; color: " + escape(getContrast(getDeliveryColor(delivery.status)), true)}"><div class="order svelte-1ita8l7">${escape(parseInt(delivery.pos) + 1)}</div> </div></ion-avatar> <ion-label button><ion-text color="#2e2e2e"><h3>${escape(delivery.title)} ${delivery.support_list && delivery.support_list.length || mustCharge(delivery) ? `<span class="notes svelte-1ita8l7"></span>` : ``}</h3> </ion-text></ion-label> ${delivery.tag_color && delivery.tag ? `<div class="stop-tag" slot="end" style="${"background-color:" + escape(hexToRGBA(delivery.tag_color, 0.3), true) + "; border: 1px solid " + escape(hexToRGBA(delivery.tag_color, 0.4), true) + "; color: " + escape(delivery.tag_color, true) + "; font-size: 10px; text-align: center; align-content: center; border-radius: 20px; white-space: normal; padding: 3px 6px; width: auto !important; display: inline-block; font-weight: 500;"}">${escape(delivery.tag ? delivery.tag : "")} </div>` : `<ion-icon${add_attribute("icon", locationOutline, 0)} slot="end" style="${"color: " + escape(getDeliveryColor(delivery.status, delivery.date_service), true)}"></ion-icon>`} </ion-item>`;
      })} <ion-item><ion-avatar slot="start"><div class="order-wrapper svelte-1ita8l7" title="${"$" + escape(stats.destination, true)}" style="${"background-color: " + escape(stats.color, true) + "; color: " + escape(getContrast(stats.color), true)}"><div class="order svelte-1ita8l7">${escape(deliveries.length + 1)}</div></div></ion-avatar> <ion-label button><ion-text color="#2e2e2e"><h3>${escape(stats.destination)}</h3></ion-text> <div class="sub svelte-1ita8l7" data-svelte-h="svelte-1284run"></div></ion-label> <ion-icon${add_attribute("icon", locationOutline, 0)} slot="end"></ion-icon></ion-item></ion-list></ion-content>` : ``}`} ${showStartButton && needsChecklistOrKmGas() ? `<ion-footer><ion-toolbar><ion-button expand="block" size="large"${add_attribute("color", routeStarted ? "success" : "primary", 0)} style="margin: 8px;">${escape(routeStarted ? "Ruta iniciada âœ“" : "Iniciar ruta")}</ion-button></ion-toolbar></ion-footer>` : ``}`}`;
    }
  })}` : ``} ${isLoading ? `<div class="overlay" style="position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; background: rgba(0, 0, 0, 0.5); display: flex; align-items: center; justify-content: center; z-index: 9999;" data-svelte-h="svelte-1aosxw0"><ion-spinner name="dots" style="color:white;"></ion-spinner></div>` : ``}`;
});

export { Page as default };
//# sourceMappingURL=_page.svelte-Dya5ECPt.js.map
